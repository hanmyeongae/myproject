<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학교 관리 시스템 - School Management System</title>

    <!-- React 및 필요한 라이브러리 CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Material-UI -->
    <script src="https://unpkg.com/@mui/material@latest/umd/material-ui.development.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />

    <!-- jsPDF for PDF generation -->
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f5f5f5;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(45deg, #1976d2, #42a5f5);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .main-content {
            flex: 1;
            display: flex;
            padding: 2rem;
            gap: 2rem;
        }

        .sidebar {
            width: 280px;
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .content-area {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .login-form {
            background: white;
            padding: 3rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #1976d2;
        }

        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.3s;
            resize: vertical;
            min-height: 100px;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #1976d2;
        }

        .btn {
            background: linear-gradient(45deg, #1976d2, #42a5f5);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s;
            width: 100%;
        }

        .btn:hover {
            background: linear-gradient(45deg, #1565c0, #1976d2);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            color: #666;
        }

        .nav-item:hover {
            background: #f0f7ff;
            color: #1976d2;
        }

        .nav-item.active {
            background: #e3f2fd;
            color: #1976d2;
            font-weight: 500;
        }

        .nav-icon {
            margin-right: 1rem;
            width: 20px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            text-align: center;
            padding: 2rem 1rem;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1976d2;
        }

        .stat-label {
            color: #666;
            margin-top: 0.5rem;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .table th {
            background: #f5f5f5;
            font-weight: 600;
            color: #333;
        }

        .table tbody tr:hover {
            background: #f9f9f9;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-present {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status-absent {
            background: #ffebee;
            color: #c62828;
        }

        .status-late {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-unexcused {
            background: #ffcdd2;
            color: #d32f2f;
            font-weight: 600;
        }

        .unexcused-count {
            background: #f44336;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            min-width: 20px;
            text-align: center;
        }

        .unexcused-form {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .guidance-form {
            background: #f3e5f5;
            border: 2px solid #9c27b0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .severity-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .severity-minor {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .severity-moderate {
            background: #fff3e0;
            color: #f57c00;
        }

        .severity-severe {
            background: #ffebee;
            color: #c62828;
        }

        .category-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
            background: #e3f2fd;
            color: #1976d2;
        }

        .resolved-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .resolved-yes {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .resolved-no {
            background: #ffebee;
            color: #c62828;
        }

        .guidance-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .guidance-stat-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            border-left: 4px solid #9c27b0;
        }

        .guidance-stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #9c27b0;
        }

        .role-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .role-admin {
            background: #fff3e0;
            color: #f57c00;
        }

        .role-homeroom {
            background: #e3f2fd;
            color: #1976d2;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }

        /* 채팅 스타일 */
        .chat-container {
            height: 500px;
            display: flex;
            flex-direction: column;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .chat-header {
            padding: 1rem;
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .chat-message {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .chat-message.own {
            align-self: flex-end;
            background: #1976d2;
            color: white;
        }

        .chat-message.other {
            align-self: flex-start;
            background: #f0f0f0;
            color: #333;
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 0.5rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            outline: none;
        }

        .chat-send-btn {
            background: #1976d2;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
        }

        .chat-send-btn:hover {
            background: #1565c0;
        }

        /* 주간계획 스타일 */
        .weekly-plan {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .day-card {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 1rem;
            min-height: 200px;
        }

        .day-header {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
            text-align: center;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #1976d2;
        }

        .day-content {
            font-size: 0.875rem;
            color: #666;
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
                padding: 1rem;
            }

            .sidebar {
                width: 100%;
                margin-bottom: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .table {
                font-size: 0.875rem;
            }

            .weekly-plan {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useContext, createContext } = React;

        // ============================================================================
        // 타입 및 상수 정의
        // ============================================================================

        const UserRole = {
            ADMIN: 'admin',
            HOMEROOM_TEACHER: 'homeroom_teacher'
        };

        const Permission = {
            // 학생 관련 권한
            VIEW_STUDENTS: 'view_students',
            MANAGE_STUDENTS: 'manage_students',
            EDIT_STUDENT_INFO: 'edit_student_info',

            // 출석 관련 권한
            VIEW_ATTENDANCE: 'view_attendance',
            MANAGE_ATTENDANCE: 'manage_attendance',

            // 학부모 관련 권한
            VIEW_PARENT_INFO: 'view_parent_info',
            CONTACT_PARENTS: 'contact_parents',

            // 반 관리 권한
            MANAGE_CLASS: 'manage_class',
            VIEW_CLASS_REPORTS: 'view_class_reports',

            // 상담 권한
            CONDUCT_COUNSELING: 'conduct_counseling',
            VIEW_COUNSELING_RECORDS: 'view_counseling_records',

            // 생활지도 권한
            MANAGE_LIFE_GUIDANCE: 'manage_life_guidance',
            VIEW_LIFE_GUIDANCE: 'view_life_guidance',
            VIEW_ALL_LIFE_GUIDANCE: 'view_all_life_guidance',

            // 관리자 권한
            MANAGE_WEEKLY_PLANS: 'manage_weekly_plans',
            VIEW_ALL_REPORTS: 'view_all_reports',
            CHAT_WITH_TEACHERS: 'chat_with_teachers'
        };

        // ============================================================================
        // 서비스 클래스
        // ============================================================================

        class AuthService {
            constructor() {
                this.sampleUsers = [
                    {
                        id: 'admin1',
                        name: '김관리',
                        email: 'admin@school.edu',
                        role: UserRole.ADMIN,
                        profileImage: 'https://via.placeholder.com/150',
                        createdAt: new Date('2023-01-01'),
                        isActive: true
                    },
                    {
                        id: 'teacher1',
                        name: '박담임',
                        email: 'homeroom1@school.edu',
                        role: UserRole.HOMEROOM_TEACHER,
                        classId: 'class-3-1',
                        className: '3학년 1반',
                        profileImage: 'https://via.placeholder.com/150',
                        createdAt: new Date('2023-01-01'),
                        isActive: true
                    },
                    {
                        id: 'teacher2',
                        name: '이담임',
                        email: 'homeroom2@school.edu',
                        role: UserRole.HOMEROOM_TEACHER,
                        classId: 'class-3-2',
                        className: '3학년 2반',
                        profileImage: 'https://via.placeholder.com/150',
                        createdAt: new Date('2023-01-01'),
                        isActive: true
                    },
                    {
                        id: 'teacher3',
                        name: '김담임',
                        email: 'homeroom3@school.edu',
                        role: UserRole.HOMEROOM_TEACHER,
                        classId: 'class-3-3',
                        className: '3학년 3반',
                        profileImage: 'https://via.placeholder.com/150',
                        createdAt: new Date('2023-01-01'),
                        isActive: true
                    },
                    {
                        id: 'teacher4',
                        name: '최담임',
                        email: 'homeroom4@school.edu',
                        role: UserRole.HOMEROOM_TEACHER,
                        classId: 'class-3-4',
                        className: '3학년 4반',
                        profileImage: 'https://via.placeholder.com/150',
                        createdAt: new Date('2023-01-01'),
                        isActive: true
                    },
                    {
                        id: 'teacher5',
                        name: '정담임',
                        email: 'homeroom5@school.edu',
                        role: UserRole.HOMEROOM_TEACHER,
                        classId: 'class-3-5',
                        className: '3학년 5반',
                        profileImage: 'https://via.placeholder.com/150',
                        createdAt: new Date('2023-01-01'),
                        isActive: true
                    },
                    {
                        id: 'teacher6',
                        name: '강담임',
                        email: 'homeroom6@school.edu',
                        role: UserRole.HOMEROOM_TEACHER,
                        classId: 'class-3-6',
                        className: '3학년 6반',
                        profileImage: 'https://via.placeholder.com/150',
                        createdAt: new Date('2023-01-01'),
                        isActive: true
                    },
                    {
                        id: 'teacher7',
                        name: '조담임',
                        email: 'homeroom7@school.edu',
                        role: UserRole.HOMEROOM_TEACHER,
                        classId: 'class-3-7',
                        className: '3학년 7반',
                        profileImage: 'https://via.placeholder.com/150',
                        createdAt: new Date('2023-01-01'),
                        isActive: true
                    },
                    {
                        id: 'teacher8',
                        name: '윤담임',
                        email: 'homeroom8@school.edu',
                        role: UserRole.HOMEROOM_TEACHER,
                        classId: 'class-3-8',
                        className: '3학년 8반',
                        profileImage: 'https://via.placeholder.com/150',
                        createdAt: new Date('2023-01-01'),
                        isActive: true
                    },
                    {
                        id: 'teacher9',
                        name: '한담임',
                        email: 'homeroom9@school.edu',
                        role: UserRole.HOMEROOM_TEACHER,
                        classId: 'class-3-9',
                        className: '3학년 9반',
                        profileImage: 'https://via.placeholder.com/150',
                        createdAt: new Date('2023-01-01'),
                        isActive: true
                    },
                    {
                        id: 'teacher10',
                        name: '오담임',
                        email: 'homeroom10@school.edu',
                        role: UserRole.HOMEROOM_TEACHER,
                        classId: 'class-3-10',
                        className: '3학년 10반',
                        profileImage: 'https://via.placeholder.com/150',
                        createdAt: new Date('2023-01-01'),
                        isActive: true
                    }
                ];
            }

            async login(email, password) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const user = this.sampleUsers.find(u => u.email === email);
                        resolve(user || null);
                    }, 1000);
                });
            }

            async logout() {
                return new Promise((resolve) => {
                    setTimeout(resolve, 500);
                });
            }
        }

        class RBACService {
            constructor() {
                this.rolePermissions = {
                    [UserRole.ADMIN]: [
                        // 관리자는 모든 권한 보유
                        Permission.VIEW_STUDENTS,
                        Permission.MANAGE_STUDENTS,
                        Permission.EDIT_STUDENT_INFO,
                        Permission.VIEW_ATTENDANCE,
                        Permission.MANAGE_ATTENDANCE,
                        Permission.VIEW_PARENT_INFO,
                        Permission.CONTACT_PARENTS,
                        Permission.MANAGE_CLASS,
                        Permission.VIEW_CLASS_REPORTS,
                        Permission.CONDUCT_COUNSELING,
                        Permission.VIEW_COUNSELING_RECORDS,
                        Permission.MANAGE_WEEKLY_PLANS,
                        Permission.VIEW_ALL_REPORTS,
                        Permission.CHAT_WITH_TEACHERS,
                        Permission.MANAGE_LIFE_GUIDANCE,
                        Permission.VIEW_LIFE_GUIDANCE,
                        Permission.VIEW_ALL_LIFE_GUIDANCE
                    ],
                    [UserRole.HOMEROOM_TEACHER]: [
                        // 담임교사는 담임 관련 권한만
                        Permission.VIEW_STUDENTS,
                        Permission.MANAGE_STUDENTS,
                        Permission.EDIT_STUDENT_INFO,
                        Permission.VIEW_ATTENDANCE,
                        Permission.MANAGE_ATTENDANCE,
                        Permission.VIEW_PARENT_INFO,
                        Permission.CONTACT_PARENTS,
                        Permission.MANAGE_CLASS,
                        Permission.VIEW_CLASS_REPORTS,
                        Permission.CONDUCT_COUNSELING,
                        Permission.VIEW_COUNSELING_RECORDS,
                        Permission.MANAGE_LIFE_GUIDANCE,
                        Permission.VIEW_LIFE_GUIDANCE
                    ]
                };
            }

            checkPermission(user, permission, resource) {
                if (!user || !user.isActive) {
                    return { allowed: false, reason: '로그인이 필요합니다.' };
                }

                const rolePermissions = this.rolePermissions[user.role] || [];
                if (!rolePermissions.includes(permission)) {
                    return { allowed: false, reason: '해당 역할에 권한이 없습니다.' };
                }

                return { allowed: true };
            }

            canAccessScreen(user, screenName) {
                const screenPermissions = {
                    'Students': [Permission.VIEW_STUDENTS],
                    'Attendance': [Permission.VIEW_ATTENDANCE],
                    'Reports': [Permission.VIEW_CLASS_REPORTS],
                    'WeeklyPlans': [Permission.MANAGE_WEEKLY_PLANS],
                    'Chat': [Permission.CHAT_WITH_TEACHERS],
                    'LifeGuidance': [Permission.VIEW_LIFE_GUIDANCE]
                };

                const requiredPermissions = screenPermissions[screenName];
                if (!requiredPermissions) return true;

                return requiredPermissions.some(permission =>
                    this.checkPermission(user, permission).allowed
                );
            }
        }

        class DataService {
            constructor() {
                this.students = [
                    // 1반
                    { id: '1', name: '홍길동', classId: 'class-3-1', className: '3학년 1반', grade: 3, studentNumber: '20230001', parentContact: '010-1234-5678', unexcusedCount: 0 },
                    { id: '2', name: '김영희', classId: 'class-3-1', className: '3학년 1반', grade: 3, studentNumber: '20230002', parentContact: '010-2345-6789', unexcusedCount: 1 },
                    { id: '3', name: '박철수', classId: 'class-3-1', className: '3학년 1반', grade: 3, studentNumber: '20230003', parentContact: '010-3456-7890', unexcusedCount: 0 },
                    // 2반
                    { id: '4', name: '이민정', classId: 'class-3-2', className: '3학년 2반', grade: 3, studentNumber: '20230004', parentContact: '010-4567-8901', unexcusedCount: 2 },
                    { id: '5', name: '정수연', classId: 'class-3-2', className: '3학년 2반', grade: 3, studentNumber: '20230005', parentContact: '010-5678-9012', unexcusedCount: 0 },
                    { id: '6', name: '최민호', classId: 'class-3-2', className: '3학년 2반', grade: 3, studentNumber: '20230006', parentContact: '010-6789-0123', unexcusedCount: 1 },
                    // 3반
                    { id: '7', name: '강지우', classId: 'class-3-3', className: '3학년 3반', grade: 3, studentNumber: '20230007', parentContact: '010-7890-1234', unexcusedCount: 0 },
                    { id: '8', name: '윤서진', classId: 'class-3-3', className: '3학년 3반', grade: 3, studentNumber: '20230008', parentContact: '010-8901-2345', unexcusedCount: 3 },
                    // 4반
                    { id: '9', name: '조현우', classId: 'class-3-4', className: '3학년 4반', grade: 3, studentNumber: '20230009', parentContact: '010-9012-3456', unexcusedCount: 1 },
                    { id: '10', name: '신예은', classId: 'class-3-4', className: '3학년 4반', grade: 3, studentNumber: '20230010', parentContact: '010-0123-4567', unexcusedCount: 0 },
                    // 5반
                    { id: '11', name: '임태준', classId: 'class-3-5', className: '3학년 5반', grade: 3, studentNumber: '20230011', parentContact: '010-1234-5679', unexcusedCount: 2 },
                    { id: '12', name: '한소영', classId: 'class-3-5', className: '3학년 5반', grade: 3, studentNumber: '20230012', parentContact: '010-2345-6780', unexcusedCount: 0 },
                    // 6반
                    { id: '13', name: '오진혁', classId: 'class-3-6', className: '3학년 6반', grade: 3, studentNumber: '20230013', parentContact: '010-3456-7891', unexcusedCount: 1 },
                    { id: '14', name: '배하늘', classId: 'class-3-6', className: '3학년 6반', grade: 3, studentNumber: '20230014', parentContact: '010-4567-8902', unexcusedCount: 4 },
                    // 7반
                    { id: '15', name: '송민재', classId: 'class-3-7', className: '3학년 7반', grade: 3, studentNumber: '20230015', parentContact: '010-5678-9013', unexcusedCount: 0 },
                    { id: '16', name: '노유진', classId: 'class-3-7', className: '3학년 7반', grade: 3, studentNumber: '20230016', parentContact: '010-6789-0124', unexcusedCount: 2 },
                    // 8반
                    { id: '17', name: '유동현', classId: 'class-3-8', className: '3학년 8반', grade: 3, studentNumber: '20230017', parentContact: '010-7890-1235', unexcusedCount: 1 },
                    { id: '18', name: '서채원', classId: 'class-3-8', className: '3학년 8반', grade: 3, studentNumber: '20230018', parentContact: '010-8901-2346', unexcusedCount: 0 },
                    // 9반
                    { id: '19', name: '김도윤', classId: 'class-3-9', className: '3학년 9반', grade: 3, studentNumber: '20230019', parentContact: '010-9012-3457', unexcusedCount: 3 },
                    { id: '20', name: '이시은', classId: 'class-3-9', className: '3학년 9반', grade: 3, studentNumber: '20230020', parentContact: '010-0123-4568', unexcusedCount: 1 },
                    // 10반
                    { id: '21', name: '박준서', classId: 'class-3-10', className: '3학년 10반', grade: 3, studentNumber: '20230021', parentContact: '010-1234-5680', unexcusedCount: 0 },
                    { id: '22', name: '정다은', classId: 'class-3-10', className: '3학년 10반', grade: 3, studentNumber: '20230022', parentContact: '010-2345-6781', unexcusedCount: 5 }
                ];

                this.attendance = [
                    { id: '1', studentId: '1', date: '2024-01-15', status: 'present', reason: '' },
                    { id: '2', studentId: '2', date: '2024-01-15', status: 'unexcused', reason: '무단결석' },
                    { id: '3', studentId: '3', date: '2024-01-15', status: 'late', reason: '' },
                    { id: '4', studentId: '4', date: '2024-01-15', status: 'absent', reason: '질병' },
                    { id: '5', studentId: '5', date: '2024-01-15', status: 'present', reason: '' },
                    { id: '6', studentId: '6', date: '2024-01-15', status: 'unexcused', reason: '무단지각' },
                    { id: '7', studentId: '7', date: '2024-01-15', status: 'present', reason: '' },
                    { id: '8', studentId: '8', date: '2024-01-15', status: 'unexcused', reason: '무단결석' },
                    { id: '9', studentId: '9', date: '2024-01-15', status: 'present', reason: '' },
                    { id: '10', studentId: '10', date: '2024-01-15', status: 'present', reason: '' },
                    { id: '11', studentId: '11', date: '2024-01-15', status: 'unexcused', reason: '무단결석' },
                    { id: '12', studentId: '12', date: '2024-01-15', status: 'present', reason: '' },
                    { id: '13', studentId: '13', date: '2024-01-15', status: 'late', reason: '' },
                    { id: '14', studentId: '14', date: '2024-01-15', status: 'unexcused', reason: '무단결석' },
                    { id: '15', studentId: '15', date: '2024-01-15', status: 'present', reason: '' },
                    { id: '16', studentId: '16', date: '2024-01-15', status: 'unexcused', reason: '무단결석' },
                    { id: '17', studentId: '17', date: '2024-01-15', status: 'present', reason: '' },
                    { id: '18', studentId: '18', date: '2024-01-15', status: 'present', reason: '' },
                    { id: '19', studentId: '19', date: '2024-01-15', status: 'unexcused', reason: '무단결석' },
                    { id: '20', studentId: '20', date: '2024-01-15', status: 'present', reason: '' },
                    { id: '21', studentId: '21', date: '2024-01-15', status: 'present', reason: '' },
                    { id: '22', studentId: '22', date: '2024-01-15', status: 'unexcused', reason: '무단결석' }
                ];

                this.weeklyPlans = [
                    {
                        id: '1',
                        department: '교무부',
                        weekStart: '2024-01-15',
                        weekEnd: '2024-01-21',
                        createdBy: 'admin1',
                        createdAt: '2024-01-14',
                        plans: {
                            monday: '전체 조회, 1교시 수학, 2교시 국어',
                            tuesday: '1교시 과학, 2교시 영어, 방과후 활동',
                            wednesday: '체육대회 준비, 3교시 음악',
                            thursday: '1교시 미술, 2교시 도덕, 학급회의',
                            friday: '주간 평가, 청소시간, 종례',
                            saturday: '',
                            sunday: ''
                        }
                    },
                    {
                        id: '2',
                        department: '학생부',
                        weekStart: '2024-01-15',
                        weekEnd: '2024-01-21',
                        createdBy: 'admin1',
                        createdAt: '2024-01-14',
                        plans: {
                            monday: '생활지도 점검, 상담실 운영',
                            tuesday: '학교폭력 예방 교육',
                            wednesday: '체육대회 안전 관리',
                            thursday: '학부모 상담 주간',
                            friday: '주간 생활지도 결과 보고',
                            saturday: '',
                            sunday: ''
                        }
                    },
                    {
                        id: '3',
                        department: '총무부',
                        weekStart: '2024-01-15',
                        weekEnd: '2024-01-21',
                        createdBy: 'admin1',
                        createdAt: '2024-01-14',
                        plans: {
                            monday: '전체 교직원 회의',
                            tuesday: '예산 계획 수립',
                            wednesday: '시설 점검 및 보수',
                            thursday: '교육과정 회의',
                            friday: '주간 업무 보고',
                            saturday: '',
                            sunday: ''
                        }
                    }
                ];

                this.chatMessages = [
                    // 개별 채팅
                    { id: '1', from: 'admin1', to: 'teacher1', message: '안녕하세요! 이번 주 계획은 어떻게 진행되고 있나요?', timestamp: new Date('2024-01-15 09:00'), sender: 'admin', type: 'individual' },
                    { id: '2', from: 'teacher1', to: 'admin1', message: '네, 순조롭게 진행되고 있습니다. 체육대회 준비가 조금 바쁘네요.', timestamp: new Date('2024-01-15 09:05'), sender: 'teacher', type: 'individual' },
                    { id: '3', from: 'admin1', to: 'teacher1', message: '수고하셨습니다. 필요한 지원이 있으면 말씀해 주세요.', timestamp: new Date('2024-01-15 09:10'), sender: 'admin', type: 'individual' },
                    // 전체 채팅
                    { id: '4', from: 'admin1', to: 'all', message: '안녕하세요! 이번 주 체육대회 준비사항을 공지드립니다. 모든 담임 선생님들의 적극적인 협조 부탁드립니다.', timestamp: new Date('2024-01-15 08:00'), sender: 'admin', type: 'group' },
                    { id: '5', from: 'teacher2', to: 'all', message: '네, 알겠습니다. 2반도 준비 완료했습니다!', timestamp: new Date('2024-01-15 08:15'), sender: 'teacher', type: 'group' },
                    { id: '6', from: 'teacher5', to: 'all', message: '5반도 준비 끝! 학생들이 정말 열심히 하네요.', timestamp: new Date('2024-01-15 08:20'), sender: 'teacher', type: 'group' },
                    { id: '7', from: 'admin1', to: 'all', message: '모든 선생님들 수고하셨습니다! 내일 최종 점검이 있으니 참고해 주세요.', timestamp: new Date('2024-01-15 08:30'), sender: 'admin', type: 'group' }
                ];

                this.lifeGuidanceRecords = [
                    {
                        id: '1',
                        studentId: '2',
                        classId: 'class-3-1',
                        teacherId: 'teacher1',
                        date: '2024-01-12',
                        category: '학교폭력',
                        severity: '경미',
                        description: '다른 학생과 보자기 더 가져가서 다툼',
                        action: '상담 및 반성문 작성',
                        parentNotified: true,
                        resolved: true
                    },
                    {
                        id: '2',
                        studentId: '8',
                        classId: 'class-3-3',
                        teacherId: 'teacher3',
                        date: '2024-01-10',
                        category: '학업방해',
                        severity: '단순',
                        description: '수업 중 잠자리 및 주의 산만',
                        action: '개별 상담 및 주의 집중 안내',
                        parentNotified: false,
                        resolved: false
                    },
                    {
                        id: '3',
                        studentId: '14',
                        classId: 'class-3-6',
                        teacherId: 'teacher6',
                        date: '2024-01-14',
                        category: '학교규칙위반',
                        severity: '단순',
                        description: '복장 미비 및 휴대폰 사용',
                        action: '주의 집중 지도 및 생활규칙 안내',
                        parentNotified: true,
                        resolved: true
                    },
                    {
                        id: '4',
                        studentId: '19',
                        classId: 'class-3-9',
                        teacherId: 'teacher9',
                        date: '2024-01-13',
                        category: '학교폭력',
                        severity: '중대',
                        description: '후배에게 지속적인 협박 및 용돈 갈취',
                        action: '학부모 대면 상담 및 전문기관 연계',
                        parentNotified: true,
                        resolved: false
                    },
                    {
                        id: '5',
                        studentId: '22',
                        classId: 'class-3-10',
                        teacherId: 'teacher10',
                        date: '2024-01-11',
                        category: '학업방해',
                        severity: '경미',
                        description: '수업 시간 떠들기 및 장난치기',
                        action: '개별 상담 및 역할 분담',
                        parentNotified: false,
                        resolved: true
                    }
                ];
            }

            async getStudents(classId) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const students = classId
                            ? this.students.filter(s => s.classId === classId)
                            : this.students;
                        resolve(students);
                    }, 500);
                });
            }

            async getAttendance(classId, date) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        let attendance = this.attendance;
                        if (date) attendance = attendance.filter(a => a.date === date);
                        resolve(attendance);
                    }, 500);
                });
            }

            async getWeeklyPlans(startDate) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const plans = startDate
                            ? this.weeklyPlans.filter(p => p.weekStart === startDate)
                            : this.weeklyPlans;
                        resolve(plans);
                    }, 500);
                });
            }

            async saveWeeklyPlan(planData) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const existingIndex = this.weeklyPlans.findIndex(p =>
                            p.department === planData.department && p.weekStart === planData.weekStart
                        );

                        if (existingIndex >= 0) {
                            this.weeklyPlans[existingIndex] = { ...this.weeklyPlans[existingIndex], ...planData };
                        } else {
                            const newPlan = {
                                id: Date.now().toString(),
                                ...planData,
                                createdAt: new Date().toISOString().split('T')[0]
                            };
                            this.weeklyPlans.push(newPlan);
                        }
                        resolve(true);
                    }, 500);
                });
            }

            async deleteWeeklyPlan(planId) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        this.weeklyPlans = this.weeklyPlans.filter(p => p.id !== planId);
                        resolve(true);
                    }, 500);
                });
            }

            async getChatMessages(userId1, userId2) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        let messages;
                        if (userId2 === 'all') {
                            // 전체 채팅 메시지
                            messages = this.chatMessages.filter(m => m.type === 'group');
                        } else {
                            // 개별 채팅 메시지
                            messages = this.chatMessages.filter(m =>
                                m.type === 'individual' &&
                                ((m.from === userId1 && m.to === userId2) ||
                                (m.from === userId2 && m.to === userId1))
                            );
                        }
                        resolve(messages);
                    }, 500);
                });
            }

            async sendChatMessage(from, to, message) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const newMessage = {
                            id: Date.now().toString(),
                            from,
                            to,
                            message,
                            timestamp: new Date(),
                            sender: from.includes('admin') ? 'admin' : 'teacher',
                            type: to === 'all' ? 'group' : 'individual'
                        };
                        this.chatMessages.push(newMessage);
                        resolve(newMessage);
                    }, 500);
                });
            }

            async getHomeroomTeachers() {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const teachers = [
                            { id: 'teacher1', name: '박담임', className: '3학년 1반' },
                            { id: 'teacher2', name: '이담임', className: '3학년 2반' },
                            { id: 'teacher3', name: '김담임', className: '3학년 3반' },
                            { id: 'teacher4', name: '최담임', className: '3학년 4반' },
                            { id: 'teacher5', name: '정담임', className: '3학년 5반' },
                            { id: 'teacher6', name: '강담임', className: '3학년 6반' },
                            { id: 'teacher7', name: '조담임', className: '3학년 7반' },
                            { id: 'teacher8', name: '윤담임', className: '3학년 8반' },
                            { id: 'teacher9', name: '한담임', className: '3학년 9반' },
                            { id: 'teacher10', name: '오담임', className: '3학년 10반' }
                        ];
                        resolve(teachers);
                    }, 500);
                });
            }

            async updateAttendance(attendanceId, status, reason) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const attendance = this.attendance.find(a => a.id === attendanceId);
                        if (attendance) {
                            attendance.status = status;
                            attendance.reason = reason || '';

                            // 미인정 결석인 경우 카운트 증가
                            if (status === 'unexcused') {
                                const student = this.students.find(s => s.id === attendance.studentId);
                                if (student) {
                                    student.unexcusedCount = (student.unexcusedCount || 0) + 1;
                                }
                            }
                        }
                        resolve(true);
                    }, 500);
                });
            }

            async addUnexcusedRecord(studentId, date, reason) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const newRecord = {
                            id: Date.now().toString(),
                            studentId,
                            date,
                            status: 'unexcused',
                            reason: reason || '무단결석'
                        };
                        this.attendance.push(newRecord);

                        // 학생 미인정 카운트 증가
                        const student = this.students.find(s => s.id === studentId);
                        if (student) {
                            student.unexcusedCount = (student.unexcusedCount || 0) + 1;
                        }

                        resolve(newRecord);
                    }, 500);
                });
            }

            async getLifeGuidanceRecords(classId) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        let records = this.lifeGuidanceRecords;
                        if (classId) {
                            records = records.filter(r => r.classId === classId);
                        }
                        resolve(records);
                    }, 500);
                });
            }

            async addLifeGuidanceRecord(record) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const newRecord = {
                            id: Date.now().toString(),
                            ...record,
                            date: record.date || new Date().toISOString().split('T')[0]
                        };
                        this.lifeGuidanceRecords.push(newRecord);
                        resolve(newRecord);
                    }, 500);
                });
            }

            async updateLifeGuidanceRecord(recordId, updates) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const record = this.lifeGuidanceRecords.find(r => r.id === recordId);
                        if (record) {
                            Object.assign(record, updates);
                        }
                        resolve(record);
                    }, 500);
                });
            }

            async deleteLifeGuidanceRecord(recordId) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        this.lifeGuidanceRecords = this.lifeGuidanceRecords.filter(r => r.id !== recordId);
                        resolve(true);
                    }, 500);
                });
            }
        }

        // ============================================================================
        // Context
        // ============================================================================

        const AuthContext = createContext();

        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [isLoading, setIsLoading] = useState(false);

            const authService = new AuthService();
            const rbacService = new RBACService();

            const login = async (email, password) => {
                setIsLoading(true);
                try {
                    const userData = await authService.login(email, password);
                    if (userData) {
                        setUser(userData);
                        localStorage.setItem('user', JSON.stringify(userData));
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('로그인 오류:', error);
                    return false;
                } finally {
                    setIsLoading(false);
                }
            };

            const logout = async () => {
                setUser(null);
                localStorage.removeItem('user');
                await authService.logout();
            };

            const checkPermission = (permission, resource) => {
                return rbacService.checkPermission(user, permission, resource);
            };

            const canAccessScreen = (screenName) => {
                return rbacService.canAccessScreen(user, screenName);
            };

            useEffect(() => {
                const storedUser = localStorage.getItem('user');
                if (storedUser) {
                    setUser(JSON.parse(storedUser));
                }
            }, []);

            return (
                <AuthContext.Provider value={{
                    user,
                    isLoading,
                    login,
                    logout,
                    checkPermission,
                    canAccessScreen,
                    isAuthenticated: !!user
                }}>
                    {children}
                </AuthContext.Provider>
            );
        };

        const useAuth = () => {
            const context = useContext(AuthContext);
            if (!context) {
                throw new Error('useAuth must be used within AuthProvider');
            }
            return context;
        };

        // ============================================================================
        // 컴포넌트들
        // ============================================================================

        // 로그인 컴포넌트
        const LoginScreen = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const { login, isLoading } = useAuth();

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');

                if (!email || !password) {
                    setError('이메일과 비밀번호를 입력해주세요.');
                    return;
                }

                const success = await login(email, password);
                if (!success) {
                    setError('로그인에 실패했습니다. 이메일과 비밀번호를 확인해주세요.');
                }
            };

            return (
                <div className="login-container">
                    <form className="login-form" onSubmit={handleSubmit}>
                        <div style={{ textAlign: 'center', marginBottom: '2rem' }}>
                            <h1 style={{ color: '#1976d2', marginBottom: '0.5rem' }}>학교 관리 시스템</h1>
                            <p style={{ color: '#666' }}>로그인하여 시스템을 이용해주세요</p>
                        </div>

                        {error && (
                            <div className="error-message">
                                {error}
                            </div>
                        )}

                        <div className="form-group">
                            <label htmlFor="email" style={{ display: 'block', marginBottom: '0.5rem', color: '#333' }}>
                                이메일
                            </label>
                            <input
                                id="email"
                                type="email"
                                className="form-input"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                placeholder="이메일을 입력하세요"
                                disabled={isLoading}
                            />
                        </div>

                        <div className="form-group">
                            <label htmlFor="password" style={{ display: 'block', marginBottom: '0.5rem', color: '#333' }}>
                                비밀번호
                            </label>
                            <input
                                id="password"
                                type="password"
                                className="form-input"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                placeholder="비밀번호를 입력하세요"
                                disabled={isLoading}
                            />
                        </div>

                        <button
                            type="submit"
                            className="btn"
                            disabled={isLoading}
                        >
                            {isLoading ? '로그인 중...' : '로그인'}
                        </button>

                        <div style={{ marginTop: '2rem', padding: '1rem', background: '#f5f5f5', borderRadius: '4px' }}>
                            <p style={{ margin: 0, fontWeight: '600', marginBottom: '0.5rem' }}>테스트 계정:</p>
                            <p style={{ margin: 0, fontSize: '0.875rem' }}>관리자: admin@school.edu</p>
                            <p style={{ margin: 0, fontSize: '0.875rem' }}>담임교사 (1~10반): homeroom1@school.edu ~ homeroom10@school.edu</p>
                            <p style={{ margin: 0, fontSize: '0.875rem' }}>예: homeroom1@school.edu (3학년 1반), homeroom5@school.edu (3학년 5반)</p>
                            <p style={{ margin: '0.5rem 0 0 0', fontSize: '0.875rem', color: '#666' }}>비밀번호는 아무거나 입력하세요</p>
                        </div>
                    </form>
                </div>
            );
        };

        // 헤더 컴포넌트
        const Header = () => {
            const { user, logout } = useAuth();

            return (
                <div className="header">
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div>
                            <h1 style={{ margin: 0, fontSize: '1.5rem' }}>학교 관리 시스템</h1>
                            <p style={{ margin: '0.25rem 0 0 0', opacity: 0.9 }}>
                                {user?.name}님 ({user?.role === UserRole.ADMIN ? '관리자' : '담임교사'})
                                {user?.className && ` - ${user.className}`}
                            </p>
                        </div>
                        <button
                            onClick={logout}
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                color: 'white',
                                border: '1px solid rgba(255,255,255,0.3)',
                                padding: '0.5rem 1rem',
                                borderRadius: '4px',
                                cursor: 'pointer'
                            }}
                        >
                            로그아웃
                        </button>
                    </div>
                </div>
            );
        };

        // 사이드바 네비게이션
        const Sidebar = ({ activeScreen, setActiveScreen }) => {
            const { user, canAccessScreen } = useAuth();

            const menuItems = [
                { id: 'dashboard', name: '대시보드', icon: '📊' },
                { id: 'students', name: '학생 관리', icon: '👥', permission: 'Students' },
                { id: 'attendance', name: '출석 관리', icon: '📅', permission: 'Attendance' },
                { id: 'life-guidance', name: user?.role === UserRole.ADMIN ? '생활지도 관리' : '생활지도', icon: '⚖️', permission: 'LifeGuidance' },
                { id: 'reports', name: '보고서', icon: '📋', permission: 'Reports' },
                { id: 'weekly-plans', name: '주간계획', icon: '📅', permission: 'WeeklyPlans', adminOnly: true },
                { id: 'chat', name: '채팅', icon: '💬', permission: 'Chat' }
            ];

            const filteredMenuItems = menuItems.filter(item => {
                if (item.adminOnly && user?.role !== UserRole.ADMIN) return false;
                return !item.permission || canAccessScreen(item.permission);
            });

            return (
                <div className="sidebar">
                    <div style={{ marginBottom: '2rem' }}>
                        <div style={{ display: 'flex', alignItems: 'center', marginBottom: '1rem' }}>
                            <img
                                src={user?.profileImage || 'https://via.placeholder.com/60'}
                                alt="Profile"
                                style={{
                                    width: '60px',
                                    height: '60px',
                                    borderRadius: '50%',
                                    marginRight: '1rem',
                                    objectFit: 'cover'
                                }}
                            />
                            <div>
                                <div style={{ fontWeight: '600', color: '#333' }}>{user?.name}</div>
                                <div style={{ fontSize: '0.875rem', color: '#666' }}>
                                    {user?.role === UserRole.ADMIN ? '시스템 관리자' : user?.className}
                                </div>
                            </div>
                        </div>
                        <div className={`role-badge ${user?.role === UserRole.ADMIN ? 'role-admin' : 'role-homeroom'}`}>
                            {user?.role === UserRole.ADMIN ? '관리자' : '담임교사'}
                        </div>
                    </div>

                    <nav>
                        {filteredMenuItems.map(item => (
                            <div
                                key={item.id}
                                className={`nav-item ${activeScreen === item.id ? 'active' : ''}`}
                                onClick={() => setActiveScreen(item.id)}
                            >
                                <span className="nav-icon">{item.icon}</span>
                                {item.name}
                            </div>
                        ))}
                    </nav>
                </div>
            );
        };

        // 대시보드 컴포넌트
        const Dashboard = () => {
            const { user } = useAuth();
            const [stats, setStats] = useState({
                totalStudents: 0,
                totalClasses: 0,
                presentToday: 0,
                pendingTasks: 0
            });

            useEffect(() => {
                // 실제 앱에서는 API에서 데이터를 가져옴
                if (user?.role === UserRole.ADMIN) {
                    setStats({
                        totalStudents: 120,
                        totalClasses: 6,
                        presentToday: 115,
                        pendingTasks: 3
                    });
                } else {
                    setStats({
                        totalStudents: 28,
                        totalClasses: 1,
                        presentToday: 26,
                        pendingTasks: 2
                    });
                }
            }, [user]);

            return (
                <div>
                    <h2 style={{ marginBottom: '2rem', color: '#333' }}>대시보드</h2>

                    <div className="stats-grid">
                        <div className="card stat-card">
                            <div className="stat-number">{stats.totalStudents}</div>
                            <div className="stat-label">전체 학생 수</div>
                        </div>
                        <div className="card stat-card">
                            <div className="stat-number">{stats.totalClasses}</div>
                            <div className="stat-label">담당 학급 수</div>
                        </div>
                        <div className="card stat-card">
                            <div className="stat-number">{stats.presentToday}</div>
                            <div className="stat-label">오늘 출석</div>
                        </div>
                        <div className="card stat-card">
                            <div className="stat-number">{stats.pendingTasks}</div>
                            <div className="stat-label">대기 중인 업무</div>
                        </div>
                    </div>

                    <div className="card">
                        <div className="card-title">최근 활동</div>
                        <div>
                            {user?.role === UserRole.ADMIN ? (
                                <div>
                                    <p>• 이번 주 주간계획 작성 완료</p>
                                    <p>• 담임교사들과 채팅 3건</p>
                                    <p>• 전체 출석률 현황 확인</p>
                                    <p>• 월간 보고서 검토</p>
                                </div>
                            ) : (
                                <div>
                                    <p>• {user?.className} 출석 체크 완료</p>
                                    <p>• 학부모 상담 일정 2건 예정</p>
                                    <p>• 학급 보고서 작성</p>
                                    <p>• 관리자와 채팅 확인</p>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="card">
                        <div className="card-title">권한 정보</div>
                        <div>
                            <p><strong>역할:</strong> {user?.role === UserRole.ADMIN ? '시스템 관리자' : '담임교사'}</p>
                            {user?.role === UserRole.ADMIN ? (
                                <div>
                                    <p><strong>관리 범위:</strong> 전체 학교</p>
                                    <p><strong>주요 권한:</strong> 주간계획 작성, 전체 보고서 조회, 담임교사 채팅</p>
                                </div>
                            ) : (
                                <div>
                                    <p><strong>담당 반:</strong> {user?.className}</p>
                                    <p><strong>주요 권한:</strong> 학생 관리, 출석 관리, 학부모 연락, 보고서 조회</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 학생 관리 컴포넌트
        const Students = () => {
            const { user, checkPermission } = useAuth();
            const [students, setStudents] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showUploadForm, setShowUploadForm] = useState(false);
            const [uploadFile, setUploadFile] = useState(null);
            const [uploadMessage, setUploadMessage] = useState('');

            const dataService = new DataService();

            useEffect(() => {
                loadStudents();
            }, []);

            const loadStudents = async () => {
                setLoading(true);
                try {
                    // 관리자는 모든 학생, 담임교사는 자신의 반만
                    const classId = user?.role === UserRole.ADMIN ? null : user?.classId;
                    const data = await dataService.getStudents(classId);
                    setStudents(data);
                } catch (error) {
                    console.error('학생 데이터 로딩 오류:', error);
                } finally {
                    setLoading(false);
                }
            };

            const handleExcelUpload = async () => {
                if (!uploadFile) {
                    setUploadMessage('파일을 선택해주세요.');
                    return;
                }

                const fileName = uploadFile.name.toLowerCase();
                if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                    setUploadMessage('엑셀 파일(.xlsx, .xls)만 업로드 가능합니다.');
                    return;
                }

                try {
                    // 실제 구현에서는 파일 읽기 라이브러리 (SheetJS 등) 사용
                    setUploadMessage('엑셀 파일 처리 중...');

                    // 가상의 업로드 처리
                    setTimeout(() => {
                        setUploadMessage('엑셀 파일이 성공적으로 업로드되었습니다.');
                        setShowUploadForm(false);
                        setUploadFile(null);
                        loadStudents(); // 학생 목록 다시 로드
                        setTimeout(() => setUploadMessage(''), 3000);
                    }, 1500);
                } catch (error) {
                    setUploadMessage('파일 업로드 중 오류가 발생했습니다.');
                    console.error(error);
                }
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                setUploadFile(file);
                if (uploadMessage) setUploadMessage('');
            };

            const canManageStudents = checkPermission(Permission.MANAGE_STUDENTS).allowed;

            if (loading) {
                return <div className="loading">학생 데이터를 불러오는 중...</div>;
            }

            return (
                <div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
                        <h2 style={{ margin: 0, color: '#333' }}>학생 관리</h2>
                        {canManageStudents && (
                            <div style={{ display: 'flex', gap: '1rem' }}>
                                <button
                                    className="btn"
                                    style={{ width: 'auto', padding: '0.5rem 1rem', background: '#4caf50' }}
                                    onClick={() => setShowUploadForm(!showUploadForm)}
                                >
                                    📊 엑셀 업로드
                                </button>
                                <button className="btn" style={{ width: 'auto', padding: '0.5rem 1rem' }}>
                                    + 학생 추가
                                </button>
                            </div>
                        )}
                    </div>

                    {/* 업로드 메시지 */}
                    {uploadMessage && (
                        <div className={uploadMessage.includes('오류') || uploadMessage.includes('가능합니다') ? 'error-message' : 'success-message'}>
                            {uploadMessage}
                        </div>
                    )}

                    {/* 엑셀 업로드 폼 */}
                    {showUploadForm && canManageStudents && (
                        <div className="card" style={{ background: '#e8f5e8', border: '2px solid #4caf50' }}>
                            <div className="card-title" style={{ color: '#2e7d32' }}>📊 학생 정보 엑셀 업로드</div>
                            <div style={{ marginBottom: '1rem' }}>
                                <p style={{ margin: '0 0 1rem 0', color: '#666', fontSize: '0.9rem' }}>
                                    엑셀 파일(.xlsx, .xls)을 업로드하여 학생 정보를 일괄 등록할 수 있습니다.
                                </p>
                                <div style={{
                                    background: '#fff3cd',
                                    border: '1px solid #ffeaa7',
                                    padding: '0.75rem',
                                    borderRadius: '4px',
                                    fontSize: '0.85rem',
                                    marginBottom: '1rem'
                                }}>
                                    <strong>📋 엑셀 파일 형식:</strong><br/>
                                    • A열: 학번, B열: 이름, C열: 학급, D열: 학부모 연락처<br/>
                                    • 첫 번째 행은 제목 행으로 건너뜁니다<br/>
                                    • 예시: 30101 | 김철수 | 3학년 1반 | 010-1234-5678
                                </div>
                            </div>
                            <div style={{ display: 'flex', alignItems: 'end', gap: '1rem' }}>
                                <div style={{ flex: 1 }}>
                                    <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600' }}>
                                        엑셀 파일 선택
                                    </label>
                                    <input
                                        type="file"
                                        accept=".xlsx,.xls"
                                        onChange={handleFileChange}
                                        style={{
                                            width: '100%',
                                            padding: '0.5rem',
                                            border: '2px dashed #4caf50',
                                            borderRadius: '4px',
                                            background: 'white',
                                            fontSize: '0.9rem'
                                        }}
                                    />
                                    {uploadFile && (
                                        <div style={{ marginTop: '0.5rem', fontSize: '0.85rem', color: '#666' }}>
                                            선택된 파일: {uploadFile.name} ({(uploadFile.size / 1024).toFixed(1)} KB)
                                        </div>
                                    )}
                                </div>
                                <div style={{ display: 'flex', gap: '0.5rem' }}>
                                    <button
                                        className="btn"
                                        style={{
                                            width: 'auto',
                                            padding: '0.5rem 1.5rem',
                                            background: '#4caf50',
                                            opacity: uploadFile ? 1 : 0.5
                                        }}
                                        onClick={handleExcelUpload}
                                        disabled={!uploadFile}
                                    >
                                        📁 업로드
                                    </button>
                                    <button
                                        className="btn btn-secondary"
                                        style={{ width: 'auto', padding: '0.5rem 1rem' }}
                                        onClick={() => {
                                            setShowUploadForm(false);
                                            setUploadFile(null);
                                            setUploadMessage('');
                                        }}
                                    >
                                        취소
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="card">
                        <div className="card-title">학생 목록</div>
                        <table className="table">
                            <thead>
                                <tr>
                                    <th>학번</th>
                                    <th>이름</th>
                                    <th>학급</th>
                                    <th>학부모 연락처</th>
                                    {canManageStudents && <th>작업</th>}
                                </tr>
                            </thead>
                            <tbody>
                                {students.map(student => (
                                    <tr key={student.id}>
                                        <td>{student.studentNumber}</td>
                                        <td>{student.name}</td>
                                        <td>{student.grade}학년</td>
                                        <td>{student.parentContact}</td>
                                        {canManageStudents && (
                                            <td>
                                                <button
                                                    style={{
                                                        background: '#1976d2',
                                                        color: 'white',
                                                        border: 'none',
                                                        padding: '0.25rem 0.75rem',
                                                        borderRadius: '4px',
                                                        cursor: 'pointer',
                                                        marginRight: '0.5rem'
                                                    }}
                                                >
                                                    수정
                                                </button>
                                                <button
                                                    style={{
                                                        background: '#d32f2f',
                                                        color: 'white',
                                                        border: 'none',
                                                        padding: '0.25rem 0.75rem',
                                                        borderRadius: '4px',
                                                        cursor: 'pointer'
                                                    }}
                                                >
                                                    삭제
                                                </button>
                                            </td>
                                        )}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // 출석 관리 컴포넌트
        const Attendance = () => {
            const { user, checkPermission } = useAuth();
            const [attendance, setAttendance] = useState([]);
            const [students, setStudents] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showUnexcusedForm, setShowUnexcusedForm] = useState(false);
            const [selectedStudent, setSelectedStudent] = useState('');
            const [unexcusedReason, setUnexcusedReason] = useState('');
            const [message, setMessage] = useState('');

            const dataService = new DataService();

            useEffect(() => {
                loadData();
            }, []);

            const loadData = async () => {
                setLoading(true);
                try {
                    const [attendanceData, studentsData] = await Promise.all([
                        dataService.getAttendance(null, '2024-01-15'),
                        dataService.getStudents(user?.role === UserRole.ADMIN ? null : user?.classId)
                    ]);

                    // 출석 데이터와 학생 데이터 결합
                    const combinedData = attendanceData.map(a => {
                        const student = studentsData.find(s => s.id === a.studentId);
                        return { ...a, studentName: student?.name || '알 수 없음', student };
                    });

                    setAttendance(combinedData);
                    setStudents(studentsData);
                } catch (error) {
                    console.error('출석 데이터 로딩 오류:', error);
                } finally {
                    setLoading(false);
                }
            };

            const getStatusText = (status) => {
                const statusMap = {
                    'present': '출석',
                    'absent': '결석',
                    'late': '지각',
                    'early_leave': '조퇴',
                    'unexcused': '미인정'
                };
                return statusMap[status] || status;
            };

            const getStatusClass = (status) => {
                const classMap = {
                    'present': 'status-present',
                    'absent': 'status-absent',
                    'late': 'status-late',
                    'early_leave': 'status-late',
                    'unexcused': 'status-unexcused'
                };
                return classMap[status] || '';
            };

            const handleAddUnexcused = async () => {
                if (!selectedStudent || !unexcusedReason) {
                    setMessage('학생과 사유를 모두 입력해주세요.');
                    return;
                }

                try {
                    await dataService.addUnexcusedRecord(selectedStudent, '2024-01-15', unexcusedReason);
                    setMessage('미인정 기록이 추가되었습니다.');
                    setShowUnexcusedForm(false);
                    setSelectedStudent('');
                    setUnexcusedReason('');
                    loadData(); // 데이터 다시 로드
                    setTimeout(() => setMessage(''), 3000);
                } catch (error) {
                    setMessage('기록 추가 중 오류가 발생했습니다.');
                    console.error(error);
                }
            };

            const canManageAttendance = checkPermission(Permission.MANAGE_ATTENDANCE).allowed;

            if (loading) {
                return <div className="loading">출석 데이터를 불러오는 중...</div>;
            }

            return (
                <div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
                        <h2 style={{ margin: 0, color: '#333' }}>출석 관리</h2>
                        {canManageAttendance && (
                            <div style={{ display: 'flex', gap: '1rem' }}>
                                <button
                                    className="btn"
                                    style={{ width: 'auto', padding: '0.5rem 1rem', background: '#f44336' }}
                                    onClick={() => setShowUnexcusedForm(!showUnexcusedForm)}
                                >
                                    미인정 기록
                                </button>
                                <button className="btn" style={{ width: 'auto', padding: '0.5rem 1rem' }}>
                                    출석 체크
                                </button>
                            </div>
                        )}
                    </div>

                    {message && (
                        <div className={message.includes('오류') ? 'error-message' : 'success-message'}>
                            {message}
                        </div>
                    )}

                    {showUnexcusedForm && canManageAttendance && (
                        <div className="unexcused-form">
                            <h4 style={{ margin: '0 0 1rem 0', color: '#f57c00' }}>🚨 미인정 기록 추가</h4>
                            <div style={{ display: 'flex', gap: '1rem', alignItems: 'end' }}>
                                <div style={{ flex: 1 }}>
                                    <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600' }}>학생 선택</label>
                                    <select
                                        className="form-input"
                                        value={selectedStudent}
                                        onChange={(e) => setSelectedStudent(e.target.value)}
                                    >
                                        <option value="">학생을 선택하세요</option>
                                        {students.map(student => (
                                            <option key={student.id} value={student.id}>
                                                {student.name} ({student.className})
                                            </option>
                                        ))}
                                    </select>
                                </div>
                                <div style={{ flex: 1 }}>
                                    <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600' }}>미인정 사유</label>
                                    <input
                                        className="form-input"
                                        value={unexcusedReason}
                                        onChange={(e) => setUnexcusedReason(e.target.value)}
                                        placeholder="예: 무단결석, 무단지각 등"
                                    />
                                </div>
                                <div>
                                    <button
                                        className="btn"
                                        style={{ width: 'auto', padding: '0.5rem 1rem', background: '#f44336' }}
                                        onClick={handleAddUnexcused}
                                    >
                                        기록 추가
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="card">
                        <div className="card-title">오늘의 출석 현황 (2024-01-15)</div>
                        <table className="table">
                            <thead>
                                <tr>
                                    <th>학생명</th>
                                    <th>학급</th>
                                    <th>출석 상태</th>
                                    <th>사유</th>
                                    <th>미인정 누적</th>
                                    <th>날짜</th>
                                    {canManageAttendance && <th>작업</th>}
                                </tr>
                            </thead>
                            <tbody>
                                {attendance.map(record => (
                                    <tr key={record.id}>
                                        <td>{record.studentName}</td>
                                        <td>{record.student?.className || '-'}</td>
                                        <td>
                                            <span className={`status-badge ${getStatusClass(record.status)}`}>
                                                {getStatusText(record.status)}
                                            </span>
                                        </td>
                                        <td>{record.reason || '-'}</td>
                                        <td>
                                            {record.student?.unexcusedCount > 0 ? (
                                                <span className="unexcused-count">
                                                    {record.student.unexcusedCount}회
                                                </span>
                                            ) : '-'}
                                        </td>
                                        <td>{record.date}</td>
                                        {canManageAttendance && (
                                            <td>
                                                <button
                                                    style={{
                                                        background: '#1976d2',
                                                        color: 'white',
                                                        border: 'none',
                                                        padding: '0.25rem 0.75rem',
                                                        borderRadius: '4px',
                                                        cursor: 'pointer'
                                                    }}
                                                >
                                                    수정
                                                </button>
                                            </td>
                                        )}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {/* 미인정 다발 학생 알림 */}
                    <div className="card">
                        <div className="card-title">⚠️ 미인정 다발 학생</div>
                        <div>
                            {students.filter(s => s.unexcusedCount >= 3).length > 0 ? (
                                <div>
                                    {students.filter(s => s.unexcusedCount >= 3).map(student => (
                                        <div key={student.id} style={{
                                            background: '#ffebee',
                                            padding: '1rem',
                                            margin: '0.5rem 0',
                                            borderRadius: '4px',
                                            border: '1px solid #f44336'
                                        }}>
                                            <strong>{student.name}</strong> ({student.className}) -
                                            <span className="unexcused-count" style={{ marginLeft: '0.5rem' }}>
                                                미인정 {student.unexcusedCount}회
                                            </span>
                                            <p style={{ margin: '0.5rem 0 0 0', fontSize: '0.875rem', color: '#666' }}>
                                                학부모 상담 필요 (연락처: {student.parentContact})
                                            </p>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <p style={{ color: '#666' }}>미인정 3회 이상 학생이 없습니다.</p>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 생활지도 컴포넌트
        const LifeGuidance = () => {
            const { user, checkPermission } = useAuth();
            const [records, setRecords] = useState([]);
            const [students, setStudents] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showAddForm, setShowAddForm] = useState(false);
            const [newRecord, setNewRecord] = useState({
                studentId: '',
                category: '',
                severity: '',
                description: '',
                action: '',
                parentNotified: false
            });
            const [message, setMessage] = useState('');
            const [stats, setStats] = useState({
                total: 0,
                resolved: 0,
                pending: 0,
                severe: 0
            });
            const [selectedClass, setSelectedClass] = useState('');
            const [selectedSeverity, setSelectedSeverity] = useState('');
            const [selectedStatus, setSelectedStatus] = useState('');

            // 관리자용 반 목록
            const classList = [
                '3학년 1반', '3학년 2반', '3학년 3반', '3학년 4반', '3학년 5반',
                '3학년 6반', '3학년 7반', '3학년 8반', '3학년 9반', '3학년 10반'
            ];

            const dataService = new DataService();

            useEffect(() => {
                loadData();
            }, []);

            const loadData = async () => {
                setLoading(true);
                try {
                    const [recordsData, studentsData] = await Promise.all([
                        dataService.getLifeGuidanceRecords(user?.role === UserRole.ADMIN ? null : user?.classId),
                        dataService.getStudents(user?.role === UserRole.ADMIN ? null : user?.classId)
                    ]);

                    // 생활지도 데이터와 학생 데이터 결합
                    const combinedData = recordsData.map(r => {
                        const student = studentsData.find(s => s.id === r.studentId);
                        return { ...r, studentName: student?.name || '알 수 없음', student };
                    });

                    setRecords(combinedData);
                    setStudents(studentsData);

                    // 통계 계산
                    const total = combinedData.length;
                    const resolved = combinedData.filter(r => r.resolved).length;
                    const pending = total - resolved;
                    const severe = combinedData.filter(r => r.severity === '중대').length;

                    setStats({ total, resolved, pending, severe });
                } catch (error) {
                    console.error('생활지도 데이터 로딩 오류:', error);
                } finally {
                    setLoading(false);
                }
            };

            const handleAddRecord = async () => {
                if (!newRecord.studentId || !newRecord.category || !newRecord.severity || !newRecord.description) {
                    setMessage('모든 필수 항목을 입력해주세요.');
                    return;
                }

                try {
                    const student = students.find(s => s.id === newRecord.studentId);
                    const recordToAdd = {
                        ...newRecord,
                        classId: student?.classId || user?.classId,
                        teacherId: user?.id,
                        resolved: false
                    };

                    await dataService.addLifeGuidanceRecord(recordToAdd);
                    setMessage('생활지도 기록이 추가되었습니다.');
                    setShowAddForm(false);
                    setNewRecord({
                        studentId: '',
                        category: '',
                        severity: '',
                        description: '',
                        action: '',
                        parentNotified: false
                    });
                    loadData(); // 데이터 다시 로드
                    setTimeout(() => setMessage(''), 3000);
                } catch (error) {
                    setMessage('기록 추가 중 오류가 발생했습니다.');
                    console.error(error);
                }
            };

            const handleResolveRecord = async (recordId) => {
                try {
                    await dataService.updateLifeGuidanceRecord(recordId, { resolved: true });
                    setMessage('기록이 해결 완료로 업데이트되었습니다.');
                    loadData();
                    setTimeout(() => setMessage(''), 3000);
                } catch (error) {
                    setMessage('업데이트 중 오류가 발생했습니다.');
                    console.error(error);
                }
            };

            const getSeverityText = (severity) => {
                const severityMap = {
                    '단순': '단순',
                    '경미': '경미',
                    '중대': '중대'
                };
                return severityMap[severity] || severity;
            };

            const getSeverityClass = (severity) => {
                const classMap = {
                    '단순': 'severity-minor',
                    '경미': 'severity-moderate',
                    '중대': 'severity-severe'
                };
                return classMap[severity] || 'severity-minor';
            };

            // 관리자용 필터링
            const filteredRecords = records.filter(record => {
                if (selectedClass && record.student?.className !== selectedClass) return false;
                if (selectedSeverity && record.severity !== selectedSeverity) return false;
                if (selectedStatus === '해결' && !record.resolved) return false;
                if (selectedStatus === '미해결' && record.resolved) return false;
                return true;
            });

            const canManageGuidance = checkPermission(Permission.MANAGE_LIFE_GUIDANCE).allowed;

            if (loading) {
                return <div className="loading">생활지도 데이터를 불러오는 중...</div>;
            }

            return (
                <div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
                        <div>
                            <h2 style={{ margin: 0, color: '#333' }}>
                                {user?.role === UserRole.ADMIN ? '생활지도 관리 시스템' : '생활지도 기록'}
                            </h2>
                            <p style={{ margin: '0.25rem 0 0 0', color: '#666', fontSize: '0.9rem' }}>
                                {user?.role === UserRole.ADMIN ? '전체 학교 생활지도 현황을 확인할 수 있습니다' : `${user?.className} 생활지도 기록`}
                            </p>
                        </div>
                        {canManageGuidance && (
                            <button
                                className="btn"
                                style={{ width: 'auto', padding: '0.5rem 1rem', background: '#9c27b0' }}
                                onClick={() => setShowAddForm(!showAddForm)}
                            >
                                + 새 기록 추가
                            </button>
                        )}
                    </div>

                    {/* 통계 카드 */}
                    <div className="guidance-stats">
                        <div className="guidance-stat-card">
                            <div className="guidance-stat-number">{stats.total}</div>
                            <div>{user?.role === UserRole.ADMIN ? '전체 기록 (전교)' : '전체 기록'}</div>
                        </div>
                        <div className="guidance-stat-card">
                            <div className="guidance-stat-number">{stats.pending}</div>
                            <div>미해결 사건</div>
                        </div>
                        <div className="guidance-stat-card">
                            <div className="guidance-stat-number">{stats.resolved}</div>
                            <div>해결완료</div>
                        </div>
                        <div className="guidance-stat-card" style={{ borderLeftColor: stats.severe > 0 ? '#f44336' : '#9c27b0' }}>
                            <div className="guidance-stat-number" style={{ color: stats.severe > 0 ? '#f44336' : '#9c27b0' }}>{stats.severe}</div>
                            <div>중대 사안 {stats.severe > 0 && '⚠️'}</div>
                        </div>
                        {user?.role === UserRole.ADMIN && (
                            <div className="guidance-stat-card" style={{ borderLeftColor: '#ff9800' }}>
                                <div className="guidance-stat-number" style={{ color: '#ff9800' }}>
                                    {records.filter(r => !r.parentNotified && !r.resolved).length}
                                </div>
                                <div>학부모 미연락</div>
                            </div>
                        )}
                    </div>

                    {message && (
                        <div className={message.includes('오류') ? 'error-message' : 'success-message'}>
                            {message}
                        </div>
                    )}

                    {/* 새 기록 추가 폼 */}
                    {showAddForm && canManageGuidance && (
                        <div className="guidance-form">
                            <h4 style={{ margin: '0 0 1rem 0', color: '#9c27b0' }}>⚖️ 새 생활지도 기록</h4>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '1rem', marginBottom: '1rem' }}>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600' }}>학생 선택</label>
                                    <select
                                        className="form-input"
                                        value={newRecord.studentId}
                                        onChange={(e) => setNewRecord(prev => ({ ...prev, studentId: e.target.value }))}
                                    >
                                        <option value="">학생을 선택하세요</option>
                                        {students.map(student => (
                                            <option key={student.id} value={student.id}>
                                                {student.name} ({student.className})
                                            </option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600' }}>위반 유형</label>
                                    <select
                                        className="form-input"
                                        value={newRecord.category}
                                        onChange={(e) => setNewRecord(prev => ({ ...prev, category: e.target.value }))}
                                    >
                                        <option value="">위반 유형 선택</option>
                                        <option value="학교폭력">학교폭력</option>
                                        <option value="학업방해">학업방해</option>
                                        <option value="학교규칙위반">학교규칙위반</option>
                                        <option value="대인관계 문제">대인관계 문제</option>
                                        <option value="기타">기타</option>
                                    </select>
                                </div>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600' }}>심각도</label>
                                    <select
                                        className="form-input"
                                        value={newRecord.severity}
                                        onChange={(e) => setNewRecord(prev => ({ ...prev, severity: e.target.value }))}
                                    >
                                        <option value="">심각도 선택</option>
                                        <option value="단순">단순</option>
                                        <option value="경미">경미</option>
                                        <option value="중대">중대</option>
                                    </select>
                                </div>
                            </div>
                            <div style={{ marginBottom: '1rem' }}>
                                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600' }}>사건 내용</label>
                                <textarea
                                    className="form-textarea"
                                    value={newRecord.description}
                                    onChange={(e) => setNewRecord(prev => ({ ...prev, description: e.target.value }))}
                                    placeholder="사건의 자세한 내용을 입력하세요..."
                                    rows="3"
                                />
                            </div>
                            <div style={{ marginBottom: '1rem' }}>
                                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600' }}>조치 사항</label>
                                <textarea
                                    className="form-textarea"
                                    value={newRecord.action}
                                    onChange={(e) => setNewRecord(prev => ({ ...prev, action: e.target.value }))}
                                    placeholder="취한 조치나 예정된 조치를 입력하세요..."
                                    rows="2"
                                />
                            </div>
                            <div style={{ display: 'flex', alignItems: 'center', marginBottom: '1rem' }}>
                                <input
                                    type="checkbox"
                                    id="parentNotified"
                                    checked={newRecord.parentNotified}
                                    onChange={(e) => setNewRecord(prev => ({ ...prev, parentNotified: e.target.checked }))}
                                    style={{ marginRight: '0.5rem' }}
                                />
                                <label htmlFor="parentNotified">학부모 연락 완료</label>
                            </div>
                            <div style={{ display: 'flex', gap: '1rem' }}>
                                <button
                                    className="btn"
                                    style={{ flex: 1, background: '#9c27b0' }}
                                    onClick={handleAddRecord}
                                >
                                    기록 추가
                                </button>
                                <button
                                    className="btn btn-secondary"
                                    style={{ flex: 1 }}
                                    onClick={() => setShowAddForm(false)}
                                >
                                    취소
                                </button>
                            </div>
                        </div>
                    )}

                    {/* 관리자용 필터 */}
                    {user?.role === UserRole.ADMIN && (
                        <div className="card" style={{ background: '#f8f9fa', border: '1px solid #e9ecef' }}>
                            <div className="card-title">필터 및 검색</div>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem' }}>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600' }}>학급 필터</label>
                                    <select
                                        className="form-input"
                                        value={selectedClass}
                                        onChange={(e) => setSelectedClass(e.target.value)}
                                    >
                                        <option value="">전체 학급</option>
                                        {classList.map(className => (
                                            <option key={className} value={className}>{className}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600' }}>심각도 필터</label>
                                    <select
                                        className="form-input"
                                        value={selectedSeverity}
                                        onChange={(e) => setSelectedSeverity(e.target.value)}
                                    >
                                        <option value="">전체 심각도</option>
                                        <option value="단순">단순</option>
                                        <option value="경미">경미</option>
                                        <option value="중대">중대</option>
                                    </select>
                                </div>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600' }}>처리 상태</label>
                                    <select
                                        className="form-input"
                                        value={selectedStatus}
                                        onChange={(e) => setSelectedStatus(e.target.value)}
                                    >
                                        <option value="">전체 상태</option>
                                        <option value="미해결">미해결</option>
                                        <option value="해결">해결완료</option>
                                    </select>
                                </div>
                                <div style={{ display: 'flex', alignItems: 'end' }}>
                                    <button
                                        className="btn btn-secondary"
                                        onClick={() => {
                                            setSelectedClass('');
                                            setSelectedSeverity('');
                                            setSelectedStatus('');
                                        }}
                                        style={{ width: '100%', padding: '0.5rem' }}
                                    >
                                        필터 초기화
                                    </button>
                                </div>
                            </div>
                            <div style={{ marginTop: '1rem', fontSize: '0.9rem', color: '#666' }}>
                                필터 결과: {filteredRecords.length}건 / 전체 {records.length}건
                            </div>
                        </div>
                    )}

                    {/* 기록 목록 */}
                    <div className="card">
                        <div className="card-title">
                            생활지도 기록 목록
                            {user?.role === UserRole.ADMIN && records.length > 0 && (
                                <span style={{ fontSize: '0.9rem', fontWeight: 'normal', color: '#666', marginLeft: '0.5rem' }}>
                                    (표시: {filteredRecords.length}건 / 전체: {records.length}건)
                                </span>
                            )}
                        </div>
                        {filteredRecords.length === 0 ? (
                            <p style={{ textAlign: 'center', color: '#666', padding: '2rem' }}>
                                {records.length === 0 ? '아직 기록이 없습니다.' : '필터 조건에 맞는 기록이 없습니다.'}
                            </p>
                        ) : (
                            <div>
                                {filteredRecords.map(record => (
                                    <div key={record.id} style={{
                                        border: '1px solid #e0e0e0',
                                        borderRadius: '8px',
                                        padding: '1.5rem',
                                        marginBottom: '1rem',
                                        background: record.resolved ? '#f9f9f9' : 'white'
                                    }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '1rem' }}>
                                            <div>
                                                <h4 style={{ margin: '0 0 0.5rem 0', color: '#333' }}>
                                                    {record.studentName} ({record.student?.className})
                                                </h4>
                                                <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                                                    <span className="category-badge">{record.category}</span>
                                                    <span className={`severity-badge ${getSeverityClass(record.severity)}`}>
                                                        {getSeverityText(record.severity)}
                                                    </span>
                                                    <span className={`resolved-badge ${record.resolved ? 'resolved-yes' : 'resolved-no'}`}>
                                                        {record.resolved ? '해결완료' : '미해결'}
                                                    </span>
                                                    {record.parentNotified && (
                                                        <span style={{ background: '#e8f5e8', color: '#2e7d32', padding: '0.25rem 0.75rem', borderRadius: '12px', fontSize: '0.875rem' }}>
                                                            학부모 연락완료
                                                        </span>
                                                    )}
                                                </div>
                                            </div>
                                            <div style={{ color: '#666', fontSize: '0.875rem' }}>{record.date}</div>
                                        </div>
                                        <div style={{ marginBottom: '1rem' }}>
                                            <strong>사건 내용:</strong>
                                            <p style={{ margin: '0.5rem 0', lineHeight: 1.5 }}>{record.description}</p>
                                        </div>
                                        {record.action && (
                                            <div style={{ marginBottom: '1rem' }}>
                                                <strong>조치 사항:</strong>
                                                <p style={{ margin: '0.5rem 0', lineHeight: 1.5 }}>{record.action}</p>
                                            </div>
                                        )}
                                        {canManageGuidance && !record.resolved && (
                                            <div style={{ textAlign: 'right' }}>
                                                <button
                                                    style={{
                                                        background: '#4caf50',
                                                        color: 'white',
                                                        border: 'none',
                                                        padding: '0.5rem 1rem',
                                                        borderRadius: '4px',
                                                        cursor: 'pointer'
                                                    }}
                                                    onClick={() => handleResolveRecord(record.id)}
                                                >
                                                    해결 완료
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 보고서 컴포넌트 (담임교사용 - 화면에서 보기)
        const Reports = () => {
            const { user } = useAuth();

            return (
                <div>
                    <h2 style={{ marginBottom: '2rem', color: '#333' }}>보고서</h2>

                    <div className="card">
                        <div className="card-title">이번 주 학급 현황 보고서</div>
                        <div style={{ lineHeight: '1.6' }}>
                            <h4>📊 출석 현황</h4>
                            <p>• 전체 출석률: 92.3%</p>
                            <p>• 지각: 2명</p>
                            <p>• 결석: 1명 (질병사유)</p>

                            <h4>👥 학급 운영</h4>
                            <p>• 학급회의 1회 실시</p>
                            <p>• 체육대회 준비 진행 중</p>
                            <p>• 청소 구역 재배정 완료</p>

                            <h4>📞 학부모 상담</h4>
                            <p>• 상담 완료: 3건</p>
                            <p>• 예정된 상담: 2건</p>
                            <p>• 주요 상담 내용: 학습 태도 개선, 교우관계</p>

                            <h4>🎯 이번 주 특이사항</h4>
                            <p>• 홍길동 학생 학습 태도 크게 향상</p>
                            <p>• 김영희 학생 리더십 발휘</p>
                            <p>• 전체적으로 체육대회 준비에 적극적 참여</p>

                            <h4>📋 다음 주 계획</h4>
                            <p>• 체육대회 최종 준비</p>
                            <p>• 학부모 면담 주간 운영</p>
                            <p>• 교실 환경 정비</p>
                        </div>
                    </div>

                    <div className="card">
                        <div className="card-title">월간 학급 성과</div>
                        <div style={{ lineHeight: '1.6' }}>
                            <h4>📈 이달의 성과</h4>
                            <p>• 평균 출석률 향상: 89% → 92%</p>
                            <p>• 학급 내 갈등 사례 감소</p>
                            <p>• 학부모 만족도 증가</p>

                            <h4>🏆 우수 학생</h4>
                            <p>• 모범상: 김영희 (리더십 발휘)</p>
                            <p>• 향상상: 홍길동 (학습 태도 개선)</p>
                            <p>• 봉사상: 박철수 (교실 정리 도우미)</p>

                            <h4>💡 개선 필요 사항</h4>
                            <p>• 일부 학생의 수업 집중도 개선 필요</p>
                            <p>• 교실 환경 정비 지속적 관리</p>
                            <p>• 학부모와의 소통 확대</p>
                        </div>
                    </div>

                    {user?.role === UserRole.ADMIN && (
                        <div className="card">
                            <div className="card-title">전체 학교 보고서</div>
                            <div style={{ lineHeight: '1.6' }}>
                                <h4>🏫 전체 현황</h4>
                                <p>• 전체 학생 수: 120명</p>
                                <p>• 전체 출석률: 94.2%</p>
                                <p>• 담임교사 수: 6명</p>

                                <h4>📊 이번 달 주요 지표</h4>
                                <p>• 학급별 평균 출석률: 90% 이상 달성</p>
                                <p>• 학부모 상담 실시율: 85%</p>
                                <p>• 교사-관리자 소통 횟수: 주 2회 이상</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 주간계획 컴포넌트 (관리자 전용 - 부서별)
        const WeeklyPlans = () => {
            const [plans, setPlans] = useState([]);
            const [loading, setLoading] = useState(true);
            const [saving, setSaving] = useState(false);
            const [message, setMessage] = useState('');
            const [showAddForm, setShowAddForm] = useState(false);
            const [viewMode, setViewMode] = useState('list'); // 'list' 또는 'overview'
            const [selectedWeek, setSelectedWeek] = useState('');
            const [newPlan, setNewPlan] = useState({
                department: '',
                weekStart: '',
                weekEnd: '',
                plans: {
                    monday: '', tuesday: '', wednesday: '', thursday: '',
                    friday: '', saturday: '', sunday: ''
                }
            });

            const dataService = new DataService();

            const days = [
                { key: 'monday', label: '월요일' },
                { key: 'tuesday', label: '화요일' },
                { key: 'wednesday', label: '수요일' },
                { key: 'thursday', label: '목요일' },
                { key: 'friday', label: '금요일' },
                { key: 'saturday', label: '토요일' },
                { key: 'sunday', label: '일요일' }
            ];

            // 주차 계산 함수
            const getWeekEnd = (startDate) => {
                const start = new Date(startDate);
                const end = new Date(start);
                end.setDate(start.getDate() + 6);
                return end.toISOString().split('T')[0];
            };

            // 주차 문자열 생성
            const getWeekString = (startDate) => {
                const start = new Date(startDate);
                const end = getWeekEnd(startDate);
                return `${start.getMonth() + 1}/${start.getDate()} ~ ${new Date(end).getMonth() + 1}/${new Date(end).getDate()}`;
            };

            useEffect(() => {
                loadWeeklyPlans();
            }, [selectedWeek, viewMode]);

            const loadWeeklyPlans = async () => {
                setLoading(true);
                try {
                    const data = await dataService.getWeeklyPlans(viewMode === 'overview' ? null : selectedWeek);
                    setPlans(data);
                } catch (error) {
                    console.error('주간계획 로딩 오류:', error);
                } finally {
                    setLoading(false);
                }
            };

            const handlePlanChange = (planId, day, value) => {
                setPlans(prev => prev.map(plan =>
                    plan.id === planId
                        ? { ...plan, plans: { ...plan.plans, [day]: value } }
                        : plan
                ));
            };

            const handleSavePlan = async (plan) => {
                setSaving(true);
                try {
                    await dataService.saveWeeklyPlan({
                        ...plan,
                        createdBy: 'admin1'
                    });
                    setMessage('주간계획이 저장되었습니다.');
                    loadWeeklyPlans();
                    setTimeout(() => setMessage(''), 3000);
                } catch (error) {
                    console.error('저장 오류:', error);
                    setMessage('저장 중 오류가 발생했습니다.');
                } finally {
                    setSaving(false);
                }
            };

            const handleAddNewPlan = async () => {
                if (!newPlan.department || !newPlan.weekStart) {
                    setMessage('부서명과 주차 시작일을 입력해주세요.');
                    return;
                }

                const planToSave = {
                    ...newPlan,
                    weekEnd: getWeekEnd(newPlan.weekStart),
                    createdBy: 'admin1'
                };

                await handleSavePlan(planToSave);
                setShowAddForm(false);
                setNewPlan({
                    department: '',
                    weekStart: '',
                    weekEnd: '',
                    plans: {
                        monday: '', tuesday: '', wednesday: '', thursday: '',
                        friday: '', saturday: '', sunday: ''
                    }
                });
            };

            const handleDeletePlan = async (planId) => {
                if (confirm('정말 삭제하시겠습니까?')) {
                    try {
                        await dataService.deleteWeeklyPlan(planId);
                        setMessage('주간계획이 삭제되었습니다.');
                        loadWeeklyPlans();
                        setTimeout(() => setMessage(''), 3000);
                    } catch (error) {
                        console.error('삭제 오류:', error);
                        setMessage('삭제 중 오류가 발생했습니다.');
                    }
                }
            };

            const handlePrintPDF = (plan) => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    // PDF 설정
                    doc.setFont('helvetica');

                    // 제목
                    doc.setFontSize(20);
                    doc.text('주간 업무 계획서', 105, 20, { align: 'center' });

                    // 부서 및 기간 정보
                    doc.setFontSize(14);
                    doc.text(`부서명: ${plan.department}`, 20, 40);
                    doc.text(`기간: ${getWeekString(plan.weekStart)}`, 20, 50);
                    doc.text(`작성일: ${new Date(plan.createdAt).toLocaleDateString()}`, 20, 60);
                    doc.text(`작성자: ${plan.createdBy === 'admin1' ? '김관리' : plan.createdBy}`, 20, 70);

                    // 구분선
                    doc.setLineWidth(0.5);
                    doc.line(20, 80, 190, 80);

                    // 주간 계획 내용
                    doc.setFontSize(12);
                    let yPos = 95;

                    days.forEach((day, index) => {
                        if (yPos > 260) { // 페이지 넘김
                            doc.addPage();
                            yPos = 30;
                        }

                        doc.setFont('helvetica', 'bold');
                        doc.text(`${day.label}:`, 20, yPos);

                        doc.setFont('helvetica', 'normal');
                        const planText = plan.plans[day.key] || '계획 없음';
                        const lines = doc.splitTextToSize(planText, 150);
                        doc.text(lines, 35, yPos);

                        yPos += Math.max(lines.length * 5, 15) + 5;
                    });

                    // 하단 정보
                    doc.setFontSize(10);
                    doc.text(`생성일: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, 20, 285);
                    doc.text('학교 관리 시스템', 190, 285, { align: 'right' });

                    // PDF 다운로드
                    doc.save(`${plan.department}_주간계획_${plan.weekStart}.pdf`);

                    setMessage('PDF 파일이 다운로드되었습니다.');
                    setTimeout(() => setMessage(''), 3000);
                } catch (error) {
                    console.error('PDF 생성 오류:', error);
                    setMessage('PDF 생성 중 오류가 발생했습니다.');
                }
            };

            const handlePrintAllPDF = () => {
                if (plans.length === 0) {
                    setMessage('출력할 계획이 없습니다.');
                    return;
                }

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    // 전체 계획 요약 PDF
                    doc.setFont('helvetica');

                    // 제목
                    doc.setFontSize(20);
                    doc.text('부서별 주간계획 종합 보고서', 105, 20, { align: 'center' });

                    // 생성 정보
                    doc.setFontSize(12);
                    doc.text(`생성일: ${new Date().toLocaleDateString()}`, 20, 40);
                    doc.text(`총 계획 수: ${plans.length}개`, 20, 50);
                    doc.text(`활성 부서: ${new Set(plans.map(p => p.department)).size}개`, 20, 60);

                    // 구분선
                    doc.setLineWidth(0.5);
                    doc.line(20, 70, 190, 70);

                    let yPos = 85;

                    plans.forEach((plan, index) => {
                        if (yPos > 250) { // 페이지 넘김
                            doc.addPage();
                            yPos = 30;
                        }

                        // 부서별 계획 제목
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${index + 1}. ${plan.department} (${getWeekString(plan.weekStart)})`, 20, yPos);
                        yPos += 10;

                        // 계획 내용 요약
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                        days.forEach(day => {
                            if (plan.plans[day.key] && plan.plans[day.key].trim()) {
                                const planText = plan.plans[day.key].substring(0, 100) + (plan.plans[day.key].length > 100 ? '...' : '');
                                doc.text(`• ${day.label}: ${planText}`, 25, yPos);
                                yPos += 5;
                            }
                        });

                        yPos += 10; // 부서간 간격
                    });

                    // 하단 정보
                    doc.setFontSize(10);
                    doc.text(`생성일: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, 20, 285);
                    doc.text('학교 관리 시스템', 190, 285, { align: 'right' });

                    // PDF 다운로드
                    doc.save(`전체_주간계획_보고서_${new Date().toISOString().split('T')[0]}.pdf`);

                    setMessage('전체 계획 PDF 파일이 다운로드되었습니다.');
                    setTimeout(() => setMessage(''), 3000);
                } catch (error) {
                    console.error('PDF 생성 오류:', error);
                    setMessage('PDF 생성 중 오류가 발생했습니다.');
                }
            };

            if (loading) {
                return <div className="loading">주간계획을 불러오는 중...</div>;
            }

            return (
                <div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
                        <div>
                            <h2 style={{ margin: 0, color: '#333' }}>부서별 주간계획 관리</h2>
                            <p style={{ margin: '0.25rem 0 0 0', color: '#666', fontSize: '0.9rem' }}>각 부서에서 주간 업무 계획을 작성하고 관리할 수 있습니다</p>
                        </div>
                        <div style={{ display: 'flex', gap: '1rem' }}>
                            <div style={{ display: 'flex', background: '#f5f5f5', borderRadius: '8px', overflow: 'hidden' }}>
                                <button
                                    style={{
                                        background: viewMode === 'list' ? '#1976d2' : 'transparent',
                                        color: viewMode === 'list' ? 'white' : '#666',
                                        border: 'none',
                                        padding: '0.5rem 1rem',
                                        cursor: 'pointer',
                                        fontSize: '0.9rem'
                                    }}
                                    onClick={() => setViewMode('list')}
                                >
                                    📋 목록보기
                                </button>
                                <button
                                    style={{
                                        background: viewMode === 'overview' ? '#1976d2' : 'transparent',
                                        color: viewMode === 'overview' ? 'white' : '#666',
                                        border: 'none',
                                        padding: '0.5rem 1rem',
                                        cursor: 'pointer',
                                        fontSize: '0.9rem'
                                    }}
                                    onClick={() => setViewMode('overview')}
                                >
                                    📊 전체보기
                                </button>
                            </div>
                            <button
                                className="btn"
                                onClick={handlePrintAllPDF}
                                style={{ width: 'auto', padding: '0.5rem 1rem', background: '#ff5722' }}
                                disabled={plans.length === 0}
                            >
                                🖨️ 전체 PDF 출력
                            </button>
                            <button
                                className="btn"
                                onClick={() => setShowAddForm(!showAddForm)}
                                style={{ width: 'auto', padding: '0.5rem 1rem', background: '#4caf50' }}
                            >
                                + 새 부서 계획 추가
                            </button>
                        </div>
                    </div>

                    {/* 날짜 필터 - 목록보기 모드에서만 표시 */}
                    {viewMode === 'list' && (
                        <div className="card" style={{ background: '#f8f9fa', border: '1px solid #e9ecef' }}>
                            <div className="card-title">주차 필터</div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600' }}>주차 선택</label>
                                    <input
                                        type="date"
                                        className="form-input"
                                        value={selectedWeek}
                                        onChange={(e) => setSelectedWeek(e.target.value)}
                                        style={{ width: '200px' }}
                                    />
                                </div>
                                <div style={{ marginTop: '1.5rem' }}>
                                    <button
                                        className="btn btn-secondary"
                                        onClick={() => setSelectedWeek('')}
                                        style={{ padding: '0.5rem 1rem' }}
                                    >
                                        전체 보기
                                    </button>
                                </div>
                            </div>
                            {selectedWeek && (
                                <div style={{ marginTop: '1rem', fontSize: '0.9rem', color: '#666' }}>
                                    선택된 주차: {getWeekString(selectedWeek)}
                                </div>
                            )}
                        </div>
                    )}

                    {/* 전체보기 모드 - 대시보드 형태로 모든 계획 한눈에 보기 */}
                    {viewMode === 'overview' && (
                        <div>
                            {/* 통계 카드 */}
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '1rem', marginBottom: '2rem' }}>
                                <div className="card" style={{ background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white' }}>
                                    <h3 style={{ margin: '0 0 0.5rem 0', fontSize: '1.2rem' }}>📊 전체 계획 수</h3>
                                    <p style={{ margin: 0, fontSize: '2rem', fontWeight: 'bold' }}>{plans.length}</p>
                                    <p style={{ margin: '0.5rem 0 0 0', opacity: 0.8, fontSize: '0.9rem' }}>등록된 부서별 주간계획</p>
                                </div>
                                <div className="card" style={{ background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', color: 'white' }}>
                                    <h3 style={{ margin: '0 0 0.5rem 0', fontSize: '1.2rem' }}>🏢 활성 부서 수</h3>
                                    <p style={{ margin: 0, fontSize: '2rem', fontWeight: 'bold' }}>{new Set(plans.map(p => p.department)).size}</p>
                                    <p style={{ margin: '0.5rem 0 0 0', opacity: 0.8, fontSize: '0.9rem' }}>계획을 등록한 부서</p>
                                </div>
                                <div className="card" style={{ background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)', color: 'white' }}>
                                    <h3 style={{ margin: '0 0 0.5rem 0', fontSize: '1.2rem' }}>📅 이번 주 계획</h3>
                                    <p style={{ margin: 0, fontSize: '2rem', fontWeight: 'bold' }}>
                                        {plans.filter(p => {
                                            const now = new Date();
                                            const planDate = new Date(p.weekStart);
                                            const weekDiff = Math.abs(now - planDate) / (1000 * 60 * 60 * 24 * 7);
                                            return weekDiff < 1;
                                        }).length}
                                    </p>
                                    <p style={{ margin: '0.5rem 0 0 0', opacity: 0.8, fontSize: '0.9rem' }}>현재 주차 계획</p>
                                </div>
                            </div>

                            {/* 부서별 계획 요약 */}
                            <div className="card">
                                <div className="card-title">📋 부서별 계획 현황</div>
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))', gap: '1.5rem' }}>
                                    {Array.from(new Set(plans.map(p => p.department))).map(department => {
                                        const deptPlans = plans.filter(p => p.department === department);
                                        return (
                                            <div key={department} style={{
                                                background: '#f8f9fa',
                                                padding: '1.5rem',
                                                borderRadius: '8px',
                                                border: '1px solid #e9ecef'
                                            }}>
                                                <h4 style={{ margin: '0 0 1rem 0', color: '#1976d2', fontSize: '1.1rem' }}>
                                                    🏢 {department}
                                                </h4>
                                                <div style={{ fontSize: '0.9rem', color: '#666', marginBottom: '1rem' }}>
                                                    총 {deptPlans.length}개 계획 등록
                                                </div>
                                                <div style={{ maxHeight: '200px', overflowY: 'auto' }}>
                                                    {deptPlans.map(plan => (
                                                        <div key={plan.id} style={{
                                                            background: 'white',
                                                            padding: '0.75rem',
                                                            marginBottom: '0.5rem',
                                                            borderRadius: '4px',
                                                            border: '1px solid #dee2e6'
                                                        }}>
                                                            <div style={{ fontWeight: '600', color: '#333', marginBottom: '0.5rem' }}>
                                                                📅 {getWeekString(plan.weekStart)}
                                                            </div>
                                                            <div style={{ fontSize: '0.8rem', color: '#666' }}>
                                                                작성일: {new Date(plan.createdAt).toLocaleDateString()}
                                                            </div>
                                                            <div style={{ fontSize: '0.8rem', color: '#666' }}>
                                                                작성자: {plan.createdBy === 'admin1' ? '김관리' : plan.createdBy}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        );
                                    })}

                                    {new Set(plans.map(p => p.department)).size === 0 && (
                                        <div style={{ gridColumn: '1 / -1', textAlign: 'center', padding: '3rem', color: '#666' }}>
                                            <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>📝</div>
                                            <h3>아직 등록된 계획이 없습니다</h3>
                                            <p>새로운 부서 계획을 추가해보세요.</p>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* 최근 계획 리스트 */}
                            <div className="card">
                                <div className="card-title">⏰ 최근 등록된 계획 (최근 10개)</div>
                                <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
                                    {plans
                                        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                                        .slice(0, 10)
                                        .map(plan => (
                                            <div key={plan.id} style={{
                                                padding: '1rem',
                                                borderBottom: '1px solid #e9ecef',
                                                display: 'flex',
                                                justifyContent: 'space-between',
                                                alignItems: 'center'
                                            }}>
                                                <div>
                                                    <div style={{ fontWeight: '600', color: '#333', marginBottom: '0.25rem' }}>
                                                        🏢 {plan.department}
                                                    </div>
                                                    <div style={{ fontSize: '0.9rem', color: '#666' }}>
                                                        📅 {getWeekString(plan.weekStart)}
                                                    </div>
                                                </div>
                                                <div style={{ textAlign: 'right', fontSize: '0.8rem', color: '#999' }}>
                                                    <div>{new Date(plan.createdAt).toLocaleDateString()}</div>
                                                    <div>{plan.createdBy === 'admin1' ? '김관리' : plan.createdBy}</div>
                                                </div>
                                            </div>
                                        ))
                                    }
                                    {plans.length === 0 && (
                                        <div style={{ textAlign: 'center', padding: '2rem', color: '#666' }}>
                                            등록된 계획이 없습니다.
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {message && (
                        <div className={message.includes('오류') ? 'error-message' : 'success-message'}>
                            {message}
                        </div>
                    )}

                    {/* 새 계획 추가 폼 */}
                    {showAddForm && (
                        <div className="card" style={{ background: '#e8f5e8', border: '2px solid #4caf50' }}>
                            <div className="card-title" style={{ color: '#2e7d32' }}>📅 새 부서 계획 추가</div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1rem' }}>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600' }}>부서명</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={newPlan.department}
                                        onChange={(e) => setNewPlan(prev => ({ ...prev, department: e.target.value }))}
                                        placeholder="예: 교무부, 학생부, 총무부 등"
                                    />
                                </div>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600' }}>주차 시작일 (월요일)</label>
                                    <input
                                        type="date"
                                        className="form-input"
                                        value={newPlan.weekStart}
                                        onChange={(e) => setNewPlan(prev => ({ ...prev, weekStart: e.target.value, weekEnd: getWeekEnd(e.target.value) }))}
                                    />
                                </div>
                            </div>
                            {newPlan.weekStart && (
                                <div style={{ marginBottom: '1rem', fontSize: '0.9rem', color: '#666' }}>
                                    계획 기간: {getWeekString(newPlan.weekStart)}
                                </div>
                            )}
                            <div className="weekly-plan" style={{ marginBottom: '1rem' }}>
                                {days.map(day => (
                                    <div key={day.key} className="day-card">
                                        <div className="day-header">{day.label}</div>
                                        <textarea
                                            className="form-textarea"
                                            value={newPlan.plans[day.key]}
                                            onChange={(e) => setNewPlan(prev => ({
                                                ...prev,
                                                plans: { ...prev.plans, [day.key]: e.target.value }
                                            }))}
                                            placeholder={`${day.label} 계획...`}
                                            style={{
                                                width: '100%',
                                                minHeight: '100px',
                                                border: 'none',
                                                background: 'white',
                                                resize: 'none',
                                                fontSize: '0.875rem'
                                            }}
                                        />
                                    </div>
                                ))}
                            </div>
                            <div style={{ display: 'flex', gap: '1rem' }}>
                                <button
                                    className="btn"
                                    onClick={handleAddNewPlan}
                                    disabled={saving}
                                    style={{ flex: 1, background: '#4caf50' }}
                                >
                                    {saving ? '저장 중...' : '계획 저장'}
                                </button>
                                <button
                                    className="btn btn-secondary"
                                    onClick={() => setShowAddForm(false)}
                                    style={{ flex: 1 }}
                                >
                                    취소
                                </button>
                            </div>
                        </div>
                    )}

                    {/* 기존 계획 목록 - 목록보기 모드에서만 표시 */}
                    {viewMode === 'list' && (
                        <div className="card">
                        <div className="card-title">부서별 주간계획 목록 ({plans.length}건)</div>
                        {plans.length === 0 ? (
                            <p style={{ textAlign: 'center', color: '#666', padding: '2rem' }}>
                                {selectedWeek ? '선택한 주차에 계획이 없습니다.' : '아직 작성된 계획이 없습니다.'}
                            </p>
                        ) : (
                            plans.map(plan => (
                                <div key={plan.id} style={{
                                    border: '1px solid #e0e0e0',
                                    borderRadius: '8px',
                                    margin: '1rem 0',
                                    background: 'white'
                                }}>
                                    <div style={{
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        padding: '1rem 1.5rem',
                                        borderBottom: '1px solid #e0e0e0',
                                        background: '#f8f9fa'
                                    }}>
                                        <div>
                                            <h3 style={{ margin: 0, color: '#333' }}>{plan.department}</h3>
                                            <p style={{ margin: '0.25rem 0 0 0', color: '#666', fontSize: '0.9rem' }}>
                                                {getWeekString(plan.weekStart)} | 작성일: {plan.createdAt}
                                            </p>
                                        </div>
                                        <div style={{ display: 'flex', gap: '0.5rem' }}>
                                            <button
                                                onClick={() => handleSavePlan(plan)}
                                                disabled={saving}
                                                style={{
                                                    background: '#1976d2',
                                                    color: 'white',
                                                    border: 'none',
                                                    padding: '0.5rem 1rem',
                                                    borderRadius: '4px',
                                                    cursor: 'pointer'
                                                }}
                                            >
                                                저장
                                            </button>
                                            <button
                                                onClick={() => handlePrintPDF(plan)}
                                                style={{
                                                    background: '#ff5722',
                                                    color: 'white',
                                                    border: 'none',
                                                    padding: '0.5rem 1rem',
                                                    borderRadius: '4px',
                                                    cursor: 'pointer',
                                                    marginRight: '0.5rem'
                                                }}
                                            >
                                                🖨️ PDF
                                            </button>
                                            <button
                                                onClick={() => handleDeletePlan(plan.id)}
                                                style={{
                                                    background: '#f44336',
                                                    color: 'white',
                                                    border: 'none',
                                                    padding: '0.5rem 1rem',
                                                    borderRadius: '4px',
                                                    cursor: 'pointer'
                                                }}
                                            >
                                                삭제
                                            </button>
                                        </div>
                                    </div>
                                    <div className="weekly-plan" style={{ padding: '1rem' }}>
                                        {days.map(day => (
                                            <div key={day.key} className="day-card">
                                                <div className="day-header">{day.label}</div>
                                                <textarea
                                                    className="form-textarea"
                                                    value={plan.plans[day.key]}
                                                    onChange={(e) => handlePlanChange(plan.id, day.key, e.target.value)}
                                                    placeholder={`${day.label} 계획...`}
                                                    style={{
                                                        width: '100%',
                                                        minHeight: '120px',
                                                        border: '1px solid #e0e0e0',
                                                        background: 'white',
                                                        resize: 'vertical',
                                                        fontSize: '0.875rem'
                                                    }}
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))
                        )}
                        </div>
                    )}
                </div>
            );
        };

        // 채팅 컴포넌트
        const Chat = () => {
            const { user } = useAuth();
            const [selectedTeacher, setSelectedTeacher] = useState(null);
            const [teachers, setTeachers] = useState([]);
            const [messages, setMessages] = useState([]);
            const [newMessage, setNewMessage] = useState('');
            const [loading, setLoading] = useState(true);

            const dataService = new DataService();

            useEffect(() => {
                loadTeachers();
            }, []);

            useEffect(() => {
                if (selectedTeacher) {
                    loadMessages();
                }
            }, [selectedTeacher]);

            const loadTeachers = async () => {
                setLoading(true);
                try {
                    const data = await dataService.getHomeroomTeachers();
                    // 전체 채팅 옵션 추가
                    const teachersWithAll = [
                        { id: 'all', name: '전체 채팅', className: '모든 담임교사' },
                        ...data
                    ];
                    setTeachers(teachersWithAll);
                    if (teachersWithAll.length > 0) {
                        setSelectedTeacher(teachersWithAll[0]); // 기본으로 전체 채팅 선택
                    }
                } catch (error) {
                    console.error('교사 목록 로딩 오류:', error);
                } finally {
                    setLoading(false);
                }
            };

            const loadMessages = async () => {
                if (!selectedTeacher) return;

                try {
                    const userId1 = user?.role === UserRole.ADMIN ? user.id : selectedTeacher.id;
                    const userId2 = user?.role === UserRole.ADMIN ? selectedTeacher.id : 'admin1';
                    const data = await dataService.getChatMessages(userId1, userId2);
                    setMessages(data);
                } catch (error) {
                    console.error('메시지 로딩 오류:', error);
                }
            };

            const handleSendMessage = async () => {
                if (!newMessage.trim() || !selectedTeacher) return;

                try {
                    const from = user.id;
                    const to = user?.role === UserRole.ADMIN ? selectedTeacher.id : 'admin1';
                    const message = await dataService.sendChatMessage(from, to, newMessage);
                    setMessages(prev => [...prev, message]);
                    setNewMessage('');
                } catch (error) {
                    console.error('메시지 전송 오류:', error);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            };

            if (loading) {
                return <div className="loading">채팅을 불러오는 중...</div>;
            }

            return (
                <div>
                    <h2 style={{ marginBottom: '2rem', color: '#333' }}>
                        {user?.role === UserRole.ADMIN ? '담임교사와 채팅' : '관리자와 채팅'}
                    </h2>

                    <div style={{ display: 'flex', gap: '2rem' }}>
                        {user?.role === UserRole.ADMIN && (
                            <div style={{ width: '300px' }}>
                                <div className="card">
                                    <div className="card-title">채팅 대상</div>
                                    {teachers.map(teacher => (
                                        <div
                                            key={teacher.id}
                                            style={{
                                                padding: '0.75rem',
                                                margin: '0.5rem 0',
                                                background: selectedTeacher?.id === teacher.id ? '#e3f2fd' : '#f5f5f5',
                                                borderRadius: '8px',
                                                cursor: 'pointer',
                                                border: selectedTeacher?.id === teacher.id ? '2px solid #1976d2' : '2px solid transparent',
                                                position: 'relative'
                                            }}
                                            onClick={() => setSelectedTeacher(teacher)}
                                        >
                                            {teacher.id === 'all' && (
                                                <div style={{
                                                    position: 'absolute',
                                                    top: '5px',
                                                    right: '10px',
                                                    background: '#4caf50',
                                                    color: 'white',
                                                    borderRadius: '12px',
                                                    padding: '2px 6px',
                                                    fontSize: '0.7rem',
                                                    fontWeight: '600'
                                                }}>
                                                    GROUP
                                                </div>
                                            )}
                                            <div style={{ fontWeight: '600', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                {teacher.id === 'all' ? '💬' : '👤'}
                                                {teacher.name}
                                            </div>
                                            <div style={{ fontSize: '0.875rem', color: '#666' }}>{teacher.className}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        <div style={{ flex: 1 }}>
                            <div className="card">
                                <div className="chat-container">
                                    <div className="chat-header" style={{
                                        background: selectedTeacher?.id === 'all' ? 'linear-gradient(45deg, #4caf50, #8bc34a)' : '#f5f5f5',
                                        color: selectedTeacher?.id === 'all' ? 'white' : '#333'
                                    }}>
                                        {user?.role === UserRole.ADMIN
                                            ? (
                                                selectedTeacher?.id === 'all'
                                                    ? '💬 전체 채팅방 - 모든 담임교사'
                                                    : `👤 ${selectedTeacher?.name} (${selectedTeacher?.className})`
                                            )
                                            : '김관리 (관리자)'
                                        }
                                        {selectedTeacher?.id === 'all' && (
                                            <div style={{ fontSize: '0.8rem', opacity: 0.9, marginTop: '2px' }}>
                                                모든 담임교사가 참여하는 단체 채팅방입니다
                                            </div>
                                        )}
                                    </div>

                                    <div className="chat-messages">
                                        {messages.map(message => {
                                            const isOwn = message.from === user.id;
                                            const senderName = isOwn
                                                ? user?.name
                                                : (message.from === 'admin1' ? '김관리' : teachers.find(t => t.id === message.from)?.name || '알 수 없음');

                                            return (
                                                <div key={message.id} style={{
                                                    display: 'flex',
                                                    flexDirection: 'column',
                                                    alignItems: isOwn ? 'flex-end' : 'flex-start',
                                                    marginBottom: '1rem'
                                                }}>
                                                    {selectedTeacher?.id === 'all' && !isOwn && (
                                                        <div style={{
                                                            fontSize: '0.75rem',
                                                            color: '#666',
                                                            marginBottom: '2px',
                                                            fontWeight: '600'
                                                        }}>
                                                            {senderName} • {message.timestamp.toLocaleTimeString().slice(0, 5)}
                                                        </div>
                                                    )}
                                                    <div
                                                        className={`chat-message ${isOwn ? 'own' : 'other'}`}
                                                        style={{
                                                            maxWidth: selectedTeacher?.id === 'all' ? '80%' : '70%',
                                                            background: isOwn
                                                                ? '#1976d2'
                                                                : (selectedTeacher?.id === 'all' ? '#e8f5e9' : '#f0f0f0'),
                                                            color: isOwn ? 'white' : '#333'
                                                        }}
                                                    >
                                                        {message.message}
                                                    </div>
                                                    {selectedTeacher?.id !== 'all' && (
                                                        <div style={{
                                                            fontSize: '0.7rem',
                                                            color: '#999',
                                                            marginTop: '2px'
                                                        }}>
                                                            {message.timestamp.toLocaleTimeString().slice(0, 5)}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                        {messages.length === 0 && (
                                            <div style={{ textAlign: 'center', color: '#666' }}>
                                                아직 대화가 없습니다. 첫 메시지를 보내보세요!
                                            </div>
                                        )}
                                    </div>

                                    <div className="chat-input-area">
                                        <input
                                            className="chat-input"
                                            value={newMessage}
                                            onChange={(e) => setNewMessage(e.target.value)}
                                            onKeyPress={handleKeyPress}
                                            placeholder={
                                                selectedTeacher?.id === 'all'
                                                    ? '모든 담임교사에게 메시지 전송...'
                                                    : '메시지를 입력하세요...'
                                            }
                                        />
                                        <button
                                            className="chat-send-btn"
                                            onClick={handleSendMessage}
                                            disabled={!newMessage.trim()}
                                        >
                                            전송
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 메인 앱 컴포넌트
        const MainApp = () => {
            const [activeScreen, setActiveScreen] = useState('dashboard');

            const renderScreen = () => {
                switch (activeScreen) {
                    case 'dashboard':
                        return <Dashboard />;
                    case 'students':
                        return <Students />;
                    case 'attendance':
                        return <Attendance />;
                    case 'life-guidance':
                        return <LifeGuidance />;
                    case 'reports':
                        return <Reports />;
                    case 'weekly-plans':
                        return <WeeklyPlans />;
                    case 'chat':
                        return <Chat />;
                    default:
                        return <Dashboard />;
                }
            };

            return (
                <div className="app-container">
                    <Header />
                    <div className="main-content">
                        <Sidebar activeScreen={activeScreen} setActiveScreen={setActiveScreen} />
                        <div className="content-area">
                            {renderScreen()}
                        </div>
                    </div>
                </div>
            );
        };

        // 앱 루트 컴포넌트
        const App = () => {
            const { isAuthenticated } = useAuth();

            return isAuthenticated ? <MainApp /> : <LoginScreen />;
        };

        // 앱 렌더링
        const AppRoot = () => (
            <AuthProvider>
                <App />
            </AuthProvider>
        );

        ReactDOM.render(<AppRoot />, document.getElementById('root'));
    </script>
</body>
</html>